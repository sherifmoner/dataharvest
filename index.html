<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harvest Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#07070f;--s1:#0d0d1a;--s2:#131320;--border:#1c1c30;--border2:#252540;--accent:#ff6b2b;--accent2:#ffaa00;--blue:#4f8ef7;--green:#22c55e;--red:#ef4444;--text:#e2e2f0;--muted:#55556e;--muted2:#8888a8}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif}

/* â”€â”€ AUTH â”€â”€ */
#auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(255,107,43,.07),transparent 70%)}
.auth-box{max-width:460px;width:100%;padding:24px;text-align:center}
.auth-icon{font-size:3.5rem;margin-bottom:20px;display:block;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.auth-box h1{font-family:'Bebas Neue',sans-serif;font-size:3.2rem;letter-spacing:.05em;margin-bottom:8px}
.auth-box h1 em{color:var(--accent);font-style:normal}
.auth-box p{color:var(--muted2);font-size:.9rem;line-height:1.6;margin-bottom:32px}
.features{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:32px;text-align:left}
.feat{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px}
.feat .fi{font-size:1.3rem;margin-bottom:6px}
.feat strong{display:block;font-size:.85rem;margin-bottom:2px}
.feat span{color:var(--muted);font-size:.75rem}
.btn-google{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:700;font-size:1rem;color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s}
.btn-google:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(255,107,43,.35)}
.btn-google svg{width:22px;height:22px}
.auth-note{margin-top:14px;font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace}

/* â”€â”€ APP â”€â”€ */
#app-screen{height:100vh;flex-direction:column;display:none}
.topbar{height:56px;background:var(--s1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.05em}
.logo em{color:var(--accent);font-style:normal}
.topbar-sep{flex:1}
#run-status{font-size:.75rem;font-family:'JetBrains Mono',monospace;color:var(--muted2);padding:4px 10px;background:var(--s2);border:1px solid var(--border);border-radius:20px;display:none}
#run-status.show{display:block}
.user-chip{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 5px;background:var(--s2);border:1px solid var(--border);border-radius:20px;font-size:.8rem;cursor:pointer;transition:all .2s}
.user-chip:hover{border-color:var(--red);color:var(--red)}
.avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;color:#000}
.content{display:flex;flex:1;overflow:hidden}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:240px;min-width:240px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-section{padding:16px 12px 6px;font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-family:'JetBrains Mono',monospace}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:2px 8px;border-radius:8px;cursor:pointer;font-size:.88rem;color:var(--muted2);transition:all .15s;border:1px solid transparent}
.nav-item:hover{background:var(--s2);color:var(--text)}
.nav-item.active{background:rgba(255,107,43,.1);color:var(--accent);border-color:rgba(255,107,43,.2)}
.nav-item .ni{width:20px;text-align:center}
.api-panel{margin:8px;border:1px solid var(--border);border-radius:10px;padding:14px;background:var(--s2)}
.ap-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;font-family:'JetBrains Mono',monospace}
.api-val{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--accent2);word-break:break-all;cursor:pointer;line-height:1.4}
.api-val:hover{color:var(--accent)}
.btn-change-api{margin-top:8px;width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.75rem;cursor:pointer;transition:all .2s}
.btn-change-api:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€ PAGES â”€â”€ */
.panel-area{flex:1;overflow-y:auto;padding:24px}
.page{display:none}
.page.active{display:block}
.page-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.05em;margin-bottom:4px}
.page-sub{color:var(--muted2);font-size:.85rem;margin-bottom:24px}

/* â”€â”€ ACTOR BROWSER â”€â”€ */
.actor-search-row{display:flex;gap:10px;margin-bottom:20px}
.search-wrap{flex:1;position:relative}
.search-wrap input{width:100%;padding:11px 14px 11px 38px;background:var(--s1);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
.btn-sec{padding:11px 16px;background:var(--s1);border:1px solid var(--border);border-radius:10px;color:var(--muted2);cursor:pointer;font-size:.85rem;transition:all .2s;font-family:'Outfit',sans-serif;white-space:nowrap}
.btn-sec:hover{border-color:var(--blue);color:var(--blue)}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.pill{padding:6px 14px;background:var(--s1);border:1px solid var(--border);border-radius:20px;font-size:.78rem;color:var(--muted2);cursor:pointer;transition:all .2s;white-space:nowrap}
.pill:hover{border-color:var(--accent);color:var(--accent)}
.pill.active{background:rgba(255,107,43,.12);border-color:var(--accent);color:var(--accent)}
.actor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.actor-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all .2s;position:relative}
.actor-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.actor-card.selected{border-color:var(--accent);background:rgba(255,107,43,.06)}
.ac-icon{font-size:1.8rem;margin-bottom:10px}
.ac-name{font-weight:600;font-size:.92rem;margin-bottom:4px}
.ac-id{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:8px}
.ac-desc{font-size:.78rem;color:var(--muted2);line-height:1.5}
.ac-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px}
.ac-tag{padding:2px 8px;background:var(--s2);border:1px solid var(--border2);border-radius:4px;font-size:.65rem;color:var(--muted2)}
.ac-badge{position:absolute;top:12px;right:12px;padding:3px 8px;border-radius:4px;font-size:.65rem;font-weight:700;background:rgba(255,107,43,.15);color:var(--accent);border:1px solid rgba(255,107,43,.3)}

/* â”€â”€ RUN PANEL â”€â”€ */
.run-layout{display:grid;grid-template-columns:1fr 380px;gap:20px}
.run-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:16px}
.run-card h3{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:.05em;color:var(--accent);margin-bottom:18px}
.form-group{margin-bottom:16px}
label{display:block;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
input[type=text],input[type=number],select,textarea{width:100%;padding:11px 13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
select option{background:var(--s1)}
textarea{resize:vertical;min-height:80px}
.hint{font-size:.72rem;color:var(--muted);margin-top:4px;font-family:'JetBrains Mono',monospace}
.actor-banner{display:flex;align-items:center;gap:14px;padding:16px;background:rgba(255,107,43,.06);border:1px solid rgba(255,107,43,.2);border-radius:10px;margin-bottom:20px}
.ab-icon{font-size:2rem}
.ab-name{font-weight:700;font-size:1rem}
.ab-id{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);margin-top:2px}
.ab-change{margin-left:auto;padding:6px 12px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.75rem;cursor:pointer;transition:all .2s}
.ab-change:hover{border-color:var(--accent);color:var(--accent)}
.sheets-row{display:flex;gap:8px}
.sheets-row select{flex:1}
.btn-icon{padding:11px 13px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted2);cursor:pointer;font-size:.9rem;transition:all .2s}
.btn-icon:hover{border-color:var(--blue);color:var(--blue)}
.btn-run{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#000;font-family:'Outfit',sans-serif;font-weight:700;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;margin-top:4px}
.btn-run:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,107,43,.35)}
.btn-run:disabled{opacity:.5;cursor:not-allowed}
.log-box{height:200px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:.72rem;line-height:1.8}
.li{color:var(--muted2)}.lok{color:var(--green)}.ler{color:var(--red)}.lw{color:var(--accent2)}.lh{color:var(--accent)}
.prog-wrap{margin-top:14px}
.prog-label{display:flex;justify-content:space-between;font-size:.72rem;color:var(--muted);margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.prog-track{height:6px;background:var(--border);border-radius:3px}
.prog-fill{height:6px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;width:0%;transition:width .4s}
.res-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.res-count{padding:4px 12px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);border-radius:20px;font-size:.75rem;color:var(--green)}
.btn-csv{padding:8px 14px;background:transparent;border:1px solid var(--border2);border-radius:7px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.78rem;cursor:pointer;transition:all .2s}
.btn-csv:hover{border-color:var(--green);color:var(--green)}
.table-wrap{overflow-x:auto;max-height:380px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{padding:9px 12px;background:var(--bg);border-bottom:1px solid var(--border);color:var(--muted);font-size:.68rem;text-transform:uppercase;letter-spacing:.06em;font-weight:400;font-family:'JetBrains Mono',monospace;text-align:left;position:sticky;top:0;white-space:nowrap}
td{padding:9px 12px;border-bottom:1px solid var(--border);color:var(--text);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:rgba(255,255,255,.02)}
td a{color:var(--blue);text-decoration:none}
.sheet-link{display:inline-flex;align-items:center;gap:8px;margin-top:14px;padding:10px 18px;background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.25);border-radius:8px;color:var(--blue);text-decoration:none;font-size:.85rem;transition:all .2s}
.sheet-link:hover{background:rgba(79,142,247,.15)}
/* HISTORY */
.history-item{display:flex;align-items:center;gap:16px;padding:16px;background:var(--s1);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;transition:border-color .2s}
.history-item:hover{border-color:var(--border2)}
.hi-name{font-weight:600;font-size:.9rem;margin-bottom:2px}
.hi-meta{font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
.hi-rows{margin-left:auto;padding:4px 12px;background:var(--s2);border:1px solid var(--border2);border-radius:20px;font-size:.75rem;color:var(--muted2)}
.hi-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.hi-dot.ok{background:var(--green)}.hi-dot.err{background:var(--red)}
/* SETTINGS */
.settings-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:16px}
.settings-card h3{font-weight:600;font-size:1rem;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.sr-label{font-size:.88rem}
.sr-sub{font-size:.75rem;color:var(--muted);margin-top:2px}
.toggle{width:44px;height:24px;background:var(--border2);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .2s}
.toggle.on::after{left:23px}
/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-bg.show{display:flex}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:16px;padding:28px;width:100%;max-width:500px;margin:20px}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:.05em;margin-bottom:18px}
.modal-btns{display:flex;gap:10px;margin-top:20px}
.btn-cancel{flex:1;padding:11px;background:transparent;border:1px solid var(--border2);border-radius:8px;color:var(--muted2);cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s}
.btn-cancel:hover{border-color:var(--red);color:var(--red)}
.btn-save{flex:1;padding:11px;background:var(--accent);border:none;border-radius:8px;color:#000;font-family:'Outfit',sans-serif;font-weight:700;cursor:pointer;transition:all .2s}
.btn-save:hover{background:var(--accent2)}
.spin{width:18px;height:18px;border:2px solid rgba(0,0,0,.25);border-top-color:#000;border-radius:50%;animation:sp .5s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .ei{font-size:3rem;margin-bottom:16px}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.alert{padding:12px 16px;border-radius:8px;font-size:.82rem;margin-bottom:16px}
.alert.err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
.alert.ok{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
.alert.info{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);color:#93c5fd}
</style>
</head>
<body>

<!-- â•â• AUTH â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <span class="auth-icon">âš¡</span>
    <h1>Harvest <em>Pro</em></h1>
    <p>Full Apify scraping control center. Pick any actor, configure city & niche, auto-save directly to your Google Sheets.</p>
    <div class="features">
      <div class="feat"><div class="fi">ğŸ—ºï¸</div><strong>Any Apify Actor</strong><span>Google Maps, Search, Social & more</span></div>
      <div class="feat"><div class="fi">ğŸ“Š</div><strong>Auto-save to Sheets</strong><span>Picks your sheets from Google Drive</span></div>
      <div class="feat"><div class="fi">ğŸ”‘</div><strong>Key Manager</strong><span>Swap Apify keys anytime</span></div>
      <div class="feat"><div class="fi">ğŸ“</div><strong>Full Data</strong><span>Phone, address, email, website</span></div>
    </div>
    <button class="btn-google" onclick="startAuth()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Sign in with Google
    </button>
    <p class="auth-note">A small popup will open for Google sign-in, then close automatically.</p>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div id="app-screen">
  <div class="topbar">
    <div class="logo">Harvest <em>Pro</em></div>
    <div class="topbar-sep"></div>
    <div id="run-status">â³ Running...</div>
    <div class="user-chip" onclick="signOut()">
      <div class="avatar" id="user-avatar">?</div>
      <span id="user-email">...</span>
      <span style="color:var(--muted);margin-left:2px">âœ•</span>
    </div>
  </div>
  <div class="content">
    <div class="sidebar">
      <div class="sidebar-section">Navigation</div>
      <div class="nav-item active" onclick="goPage('actors',this)"><span class="ni">ğŸ”</span>Actor Browser</div>
      <div class="nav-item" onclick="goPage('run',this)"><span class="ni">â–¶ï¸</span>Run & Configure</div>
      <div class="nav-item" onclick="goPage('history',this)"><span class="ni">ğŸ“‚</span>Run History</div>
      <div class="nav-item" onclick="goPage('settings',this)"><span class="ni">âš™ï¸</span>Settings</div>
      <div style="margin-top:auto">
        <div class="sidebar-section">Apify API Key</div>
        <div class="api-panel">
          <div class="ap-label">Active Key</div>
          <div class="api-val" id="api-key-display" onclick="openApiModal()">Not set â€” click to add</div>
          <button class="btn-change-api" onclick="openApiModal()">ğŸ”‘ Change API Key</button>
        </div>
      </div>
    </div>

    <div class="panel-area">

      <!-- ACTOR BROWSER -->
      <div id="page-actors" class="page active">
        <div class="page-title">Actor Browser</div>
        <div class="page-sub">Click any actor to configure and run it. Use Search Apify Store to find more actors.</div>
        <div class="actor-search-row">
          <div class="search-wrap">
            <span class="si">ğŸ”</span>
            <input type="text" id="actor-q" placeholder="Search actors: google maps, instagram, amazon..." oninput="filterActors()">
          </div>
          <button class="btn-sec" onclick="searchStore()">ğŸ”„ Search Apify Store</button>
        </div>
        <div class="pills">
          <div class="pill active" onclick="setCat('all',this)">All</div>
          <div class="pill" onclick="setCat('maps',this)">ğŸ—º Maps & Places</div>
          <div class="pill" onclick="setCat('search',this)">ğŸ” Search Engines</div>
          <div class="pill" onclick="setCat('social',this)">ğŸ“± Social Media</div>
          <div class="pill" onclick="setCat('ecommerce',this)">ğŸ› E-Commerce</div>
          <div class="pill" onclick="setCat('leads',this)">ğŸ‘¥ Leads</div>
          <div class="pill" onclick="setCat('web',this)">ğŸŒ Web Scraping</div>
        </div>
        <div class="actor-grid" id="actor-grid"></div>
      </div>

      <!-- RUN -->
      <div id="page-run" class="page">
        <div class="page-title">Run & Configure</div>
        <div class="page-sub">Configure your job, pick a Google Sheet, and start scraping.</div>
        <div id="no-actor" class="empty"><div class="ei">ğŸ‘†</div><p>Select an actor from the <strong>Actor Browser</strong> first.</p></div>
        <div id="run-content" style="display:none">
          <div class="actor-banner">
            <div class="ab-icon" id="ab-icon">âš™ï¸</div>
            <div><div class="ab-name" id="ab-name">-</div><div class="ab-id" id="ab-id">-</div></div>
            <button class="ab-change" onclick="goPage('actors',document.querySelector('.nav-item'))">â† Change</button>
          </div>
          <div class="run-layout">
            <div>
              <div class="run-card">
                <h3>âš™ Actor Configuration</h3>
                <div id="dyn-form"></div>
                <details style="margin-top:16px">
                  <summary style="cursor:pointer;font-size:.8rem;color:var(--muted2);user-select:none">â–¸ Advanced: Raw JSON input</summary>
                  <div style="margin-top:10px">
                    <label>Custom JSON (overrides form above)</label>
                    <textarea id="raw-json" placeholder='{"searchStringsArray":["coffee shops in Cairo"],"maxCrawledPlacesPerSearch":50}'></textarea>
                  </div>
                </details>
              </div>
              <div class="run-card" id="res-card" style="display:none">
                <div class="res-header">
                  <h3 style="margin:0">ğŸ“Š Results</h3>
                  <div style="display:flex;gap:8px;align-items:center">
                    <span class="res-count" id="res-count">0 rows</span>
                    <button class="btn-csv" onclick="dlCSV()">â¬‡ CSV</button>
                  </div>
                </div>
                <div class="table-wrap"><table><thead id="res-head"></thead><tbody id="res-body"></tbody></table></div>
                <a class="sheet-link" id="sheet-link" href="#" target="_blank">ğŸ“Š Open Google Sheet</a>
              </div>
            </div>
            <div>
              <div class="run-card">
                <h3>ğŸ“Š Save to Google Sheets</h3>
                <div id="sheets-alert"></div>
                <div class="form-group">
                  <label>Spreadsheet</label>
                  <div class="sheets-row">
                    <select id="sheet-sel" onchange="loadTabs(this.value)">
                      <option value="">â€” select a spreadsheet â€”</option>
                    </select>
                    <button class="btn-icon" onclick="loadSheets()" title="Refresh sheets list">ğŸ”„</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Tab name</label>
                  <div class="sheets-row">
                    <select id="tab-sel"><option value="">â€” select tab â€”</option></select>
                    <button class="btn-icon" onclick="openTabModal()" title="New tab">ï¼‹</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Or type a custom tab name</label>
                  <input type="text" id="custom-tab" placeholder="e.g. Cairo Leads July 2025">
                  <div class="hint">Fills this text overrides tab dropdown</div>
                </div>
              </div>
              <div class="run-card">
                <h3>â–¶ Execute</h3>
                <button class="btn-run" id="btn-run" onclick="runActor()"><span>â–¶ Start Scraping</span></button>
                <div class="prog-wrap" id="prog-wrap" style="display:none">
                  <div class="prog-label"><span id="prog-lbl">Starting...</span><span id="prog-pct">0%</span></div>
                  <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
                </div>
                <div style="margin-top:14px">
                  <label>Live Log</label>
                  <div class="log-box" id="log-box"><span class="li">// Ready. Configure and press Start.</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div id="page-history" class="page">
        <div class="page-title">Run History</div>
        <div class="page-sub">All scraping jobs from this session.</div>
        <div id="history-list"><div class="empty"><div class="ei">ğŸ“‚</div><p>No runs yet.</p></div></div>
      </div>

      <!-- SETTINGS -->
      <div id="page-settings" class="page">
        <div class="page-title">Settings</div>
        <div class="page-sub">Manage keys and preferences.</div>
        <div class="settings-card">
          <h3>ğŸ”‘ Apify API Key</h3>
          <div class="form-group">
            <label>API Key</label>
            <input type="text" id="s-apify-key" placeholder="apify_api_...">
            <div class="hint">Get it at: console.apify.com â†’ Settings â†’ Integrations</div>
          </div>
          <button class="btn-run" style="max-width:160px" onclick="saveKey()">Save Key</button>
        </div>
        <div class="settings-card">
          <h3>âš™ Preferences</h3>
          <div class="setting-row">
            <div><div class="sr-label">Auto-open sheet after run</div><div class="sr-sub">Opens Google Sheets when done</div></div>
            <div class="toggle" id="tog-open" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="setting-row">
            <div><div class="sr-label">Append rows (don't overwrite)</div><div class="sr-sub">Adds data below existing rows</div></div>
            <div class="toggle on" id="tog-append" onclick="this.classList.toggle('on')"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- API KEY MODAL -->
<div class="modal-bg" id="api-modal">
  <div class="modal">
    <h3>ğŸ”‘ Set Apify API Key</h3>
    <div class="form-group">
      <label>Apify API Key</label>
      <input type="text" id="m-api-key" placeholder="apify_api_...">
      <div class="hint">console.apify.com â†’ Settings â†’ Integrations â†’ API tokens</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeApiModal()">Cancel</button>
      <button class="btn-save" onclick="confirmApiKey()">Save & Test</button>
    </div>
  </div>
</div>

<!-- NEW TAB MODAL -->
<div class="modal-bg" id="tab-modal">
  <div class="modal">
    <h3>â• New Tab Name</h3>
    <div class="form-group">
      <label>Tab Name</label>
      <input type="text" id="m-tab" placeholder="e.g. Cairo Coffee Shops">
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeTabModal()">Cancel</button>
      <button class="btn-save" onclick="confirmTab()">Use This Name</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID = '633930604616-oda4vnsest0uhg8ivci8uv2j3g7iovh7.apps.googleusercontent.com';
const SCOPES = [
  'https://www.googleapis.com/auth/spreadsheets',
  'https://www.googleapis.com/auth/drive.metadata.readonly',
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/userinfo.profile'
].join(' ');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  token: null,
  apifyKey: localStorage.getItem('hp_apify') || '',
  actor: null,
  results: [],
  headers: [],
  history: [],
  cat: 'all'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTORS CATALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACTORS = [
  {
    id: 'compass/crawler-google-places',
    name: 'Google Maps Scraper',
    icon: 'ğŸ—ºï¸', cat: 'maps', badge: true,
    desc: 'Scrapes Google Maps businesses. Returns name, address, phone, website, rating, reviews, coordinates.',
    tags: ['maps','leads','phone','address'],
    // FIX: correct input schema for this actor
    buildInput(f) {
      const queries = (f.niche||'').split('\n').map(s=>s.trim()).filter(Boolean);
      const city = f.city || '';
      return {
        searchStringsArray: queries.map(q => city ? `${q} in ${city}` : q),
        maxCrawledPlacesPerSearch: parseInt(f.maxResults) || 50,
        language: f.language || 'en',
        includeWebResults: false,
        maxImages: 0,
        maxReviews: 0
      };
    },
    form: [
      {key:'niche', label:'Business Type / Niche (one per line)', type:'textarea', placeholder:'coffee shops\nrestaurants\ngyms\ndentists'},
      {key:'city',  label:'City / Location', type:'text', placeholder:'Cairo, Egypt'},
      {key:'maxResults', label:'Max Results Per Search', type:'number', default:'50'},
      {key:'language', label:'Language', type:'select', options:['en','ar','fr','de','es'], default:'en'}
    ]
  },
  {
    id: 'apify/google-search-scraper',
    name: 'Google Search Scraper',
    icon: 'ğŸ”', cat: 'search', badge: true,
    desc: 'Scrapes Google search results. Returns title, URL, description, position.',
    tags: ['google','seo','search'],
    buildInput(f) {
      return {
        queries: (f.queries||'').split('\n').map(s=>s.trim()).filter(Boolean).join('\n'),
        maxPagesPerQuery: parseInt(f.pages)||1,
        resultsPerPage: parseInt(f.rpp)||10,
        countryCode: f.country||'eg',
        languageCode: f.lang||'en',
        mobileResults: false
      };
    },
    form: [
      {key:'queries', label:'Search Queries (one per line)', type:'textarea', placeholder:'best restaurants in Cairo\nmarketing agencies Egypt'},
      {key:'pages',   label:'Pages Per Query', type:'number', default:'1'},
      {key:'rpp',     label:'Results Per Page', type:'select', options:['10','20','50','100'], default:'10'},
      {key:'country', label:'Country Code', type:'select', options:['eg','us','gb','ae','sa','fr','de'], default:'eg'},
      {key:'lang',    label:'Language', type:'select', options:['en','ar','fr','de'], default:'en'}
    ]
  },
  {
    id: 'apify/instagram-scraper',
    name: 'Instagram Scraper',
    icon: 'ğŸ“¸', cat: 'social',
    desc: 'Scrapes Instagram profiles, posts, hashtags. Returns followers, posts, bio, links.',
    tags: ['instagram','social','influencer'],
    buildInput(f) {
      return {
        directUrls: (f.urls||'').split('\n').map(s=>s.trim()).filter(Boolean),
        resultsLimit: parseInt(f.limit)||50,
        addParentData: false
      };
    },
    form: [
      {key:'urls',  label:'Instagram URLs (one per line)', type:'textarea', placeholder:'https://www.instagram.com/username/\nhttps://www.instagram.com/explore/tags/cairo/'},
      {key:'limit', label:'Max Posts / Profiles', type:'number', default:'50'}
    ]
  },
  {
    id: 'apify/twitter-scraper',
    name: 'Twitter / X Scraper',
    icon: 'ğŸ¦', cat: 'social',
    desc: 'Scrapes tweets, profiles and hashtag data.',
    tags: ['twitter','x','social'],
    buildInput(f) {
      return {
        searchTerms: (f.terms||'').split('\n').map(s=>s.trim()).filter(Boolean),
        maxTweets: parseInt(f.max)||100,
        startDate: f.date || undefined
      };
    },
    form: [
      {key:'terms', label:'Search Terms / Hashtags (one per line)', type:'textarea', placeholder:'#cairo\nEgypt startups'},
      {key:'max',   label:'Max Tweets', type:'number', default:'100'},
      {key:'date',  label:'Start Date (optional)', type:'text', placeholder:'2024-01-01'}
    ]
  },
  {
    id: 'apify/facebook-pages-scraper',
    name: 'Facebook Pages Scraper',
    icon: 'ğŸ‘¥', cat: 'social',
    desc: 'Scrapes Facebook pages â€” info, posts, likes, contact details.',
    tags: ['facebook','social','pages'],
    buildInput(f) {
      return {
        startUrls: (f.urls||'').split('\n').map(s=>s.trim()).filter(Boolean).map(u=>({url:u})),
        maxPosts: parseInt(f.max)||20
      };
    },
    form: [
      {key:'urls', label:'Facebook Page URLs (one per line)', type:'textarea', placeholder:'https://www.facebook.com/pagename'},
      {key:'max',  label:'Max Posts', type:'number', default:'20'}
    ]
  },
  {
    id: 'apify/amazon-product-scraper',
    name: 'Amazon Product Scraper',
    icon: 'ğŸ“¦', cat: 'ecommerce', badge: true,
    desc: 'Scrapes Amazon products â€” title, price, rating, ASIN, reviews count.',
    tags: ['amazon','products','prices'],
    buildInput(f) {
      return {
        keywords: f.kw||'',
        maxItems: parseInt(f.max)||50,
        country: f.country||'US'
      };
    },
    form: [
      {key:'kw',      label:'Search Keywords', type:'text', placeholder:'wireless earbuds'},
      {key:'max',     label:'Max Products', type:'number', default:'50'},
      {key:'country', label:'Amazon Site', type:'select', options:['US','UK','DE','FR','AE','SA'], default:'US'}
    ]
  },
  {
    id: 'apify/booking-scraper',
    name: 'Booking.com Scraper',
    icon: 'ğŸ¨', cat: 'ecommerce',
    desc: 'Scrapes hotel listings â€” name, price, rating, location, amenities.',
    tags: ['hotels','travel','prices'],
    buildInput(f) {
      return {
        search: f.dest||'',
        checkIn: f.in||'',
        checkOut: f.out||'',
        maxResults: parseInt(f.max)||30
      };
    },
    form: [
      {key:'dest', label:'Destination', type:'text', placeholder:'Cairo, Egypt'},
      {key:'in',   label:'Check-in Date', type:'text', placeholder:'2025-08-01'},
      {key:'out',  label:'Check-out Date', type:'text', placeholder:'2025-08-05'},
      {key:'max',  label:'Max Hotels', type:'number', default:'30'}
    ]
  },
  {
    id: 'apify/yelp-scraper',
    name: 'Yelp Business Scraper',
    icon: 'â­', cat: 'leads', badge: true,
    desc: 'Scrapes Yelp â€” business name, address, phone, rating, category, website.',
    tags: ['yelp','leads','phone','address'],
    buildInput(f) {
      return {
        searchTerms: f.niche||'',
        location: f.city||'',
        maxItems: parseInt(f.max)||50
      };
    },
    form: [
      {key:'niche', label:'Business Type / Niche', type:'text', placeholder:'restaurants'},
      {key:'city',  label:'City / Location', type:'text', placeholder:'Cairo'},
      {key:'max',   label:'Max Results', type:'number', default:'50'}
    ]
  },
  {
    id: 'apify/web-scraper',
    name: 'Universal Web Scraper',
    icon: 'ğŸŒ', cat: 'web',
    desc: 'Crawl any website and extract text, links, and structured data.',
    tags: ['web','crawler','general'],
    buildInput(f) {
      const urls = (f.urls||'').split('\n').map(s=>s.trim()).filter(Boolean);
      return {
        startUrls: urls.map(u=>({url:u})),
        maxCrawlPages: parseInt(f.pages)||10,
        maxCrawlDepth: parseInt(f.depth)||2
      };
    },
    form: [
      {key:'urls',  label:'Start URLs (one per line)', type:'textarea', placeholder:'https://example.com'},
      {key:'pages', label:'Max Pages to Crawl', type:'number', default:'10'},
      {key:'depth', label:'Crawl Depth', type:'number', default:'2'}
    ]
  },
  {
    id: 'apify/cheerio-scraper',
    name: 'Fast HTML Scraper',
    icon: 'âš¡', cat: 'web',
    desc: 'High-speed scraper using CSS selectors â€” great for structured pages.',
    tags: ['html','fast','css'],
    buildInput(f) {
      return {
        startUrls: [{url: f.url||''}],
        maxRequestsPerCrawl: parseInt(f.max)||100
      };
    },
    form: [
      {key:'url', label:'Start URL', type:'text', placeholder:'https://example.com'},
      {key:'max', label:'Max Requests', type:'number', default:'100'}
    ]
  }
];

let visibleActors = [...ACTORS];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE OAUTH â€” POPUP APPROACH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAuth() {
  const REDIRECT = window.location.origin + window.location.pathname;
  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT,
    response_type: 'token',
    scope: SCOPES,
    prompt: 'consent'
  });
  const url = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
  const popup = window.open(url, 'google_auth', 'width=500,height=620,left=300,top=80,scrollbars=yes');

  if (!popup) {
    // Popup blocked â€” fall back to redirect
    window.location.href = url + '&redirect_uri=' + encodeURIComponent(REDIRECT);
    return;
  }

  const timer = setInterval(() => {
    try {
      if (!popup || popup.closed) { clearInterval(timer); return; }
      const href = popup.location.href;
      if (href.includes('access_token') || href.includes(window.location.origin)) {
        clearInterval(timer);
        const hash = href.includes('#') ? href.split('#')[1] : href.split('?')[1];
        const p = new URLSearchParams(hash);
        const token = p.get('access_token');
        if (token) { popup.close(); onToken(token); }
      }
    } catch(e) { /* cross-origin â€” still loading */ }
  }, 300);
}

// Handle redirect back (in case popup was blocked and fell back to redirect)
window.addEventListener('load', () => {
  const hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    const p = new URLSearchParams(hash.substring(1));
    const token = p.get('access_token');
    history.replaceState({}, '', window.location.pathname);
    if (token) onToken(token);
  }
  if (S.apifyKey) { updateApiDisplay(); document.getElementById('s-apify-key').value = S.apifyKey; }
  renderActors();
});

async function onToken(token) {
  S.token = token;
  // Get user info
  try {
    const r = await gFetch('https://www.googleapis.com/oauth2/v2/userinfo');
    document.getElementById('user-email').textContent = r.email || r.name;
    document.getElementById('user-avatar').textContent = (r.name || r.email || '?')[0].toUpperCase();
  } catch(e) {
    document.getElementById('user-email').textContent = 'Signed in';
  }
  document.getElementById('auth-screen').style.display = 'none';
  const app = document.getElementById('app-screen');
  app.style.display = 'flex';
  app.style.flexDirection = 'column';
  // Auto-load sheets
  await loadSheets();
}

function signOut() {
  S.token = null;
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app-screen').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function gFetch(url, opts={}) {
  const res = await fetch(url, {
    ...opts,
    headers: { 'Authorization': `Bearer ${S.token}`, 'Content-Type': 'application/json', ...(opts.headers||{}) }
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err?.error?.message || `HTTP ${res.status}`);
  }
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD SHEETS â€” FIX: Use Drive Files API correctly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSheets() {
  const sel = document.getElementById('sheet-sel');
  const alert = document.getElementById('sheets-alert');
  sel.innerHTML = '<option value="">Loading your sheets...</option>';
  alert.innerHTML = '';
  try {
    // This is the correct endpoint to list spreadsheets
    const data = await gFetch(
      `https://www.googleapis.com/drive/v3/files?` +
      `q=mimeType%3D'application%2Fvnd.google-apps.spreadsheet'+and+trashed%3Dfalse` +
      `&fields=files(id%2Cname)&pageSize=100&orderBy=modifiedTime+desc`
    );
    const files = data.files || [];
    if (!files.length) {
      sel.innerHTML = '<option value="">No spreadsheets found in your Drive</option>';
      alert.innerHTML = '<div class="alert info">No Google Sheets found. Create one at sheets.google.com first, then click ğŸ”„ to refresh.</div>';
      return;
    }
    sel.innerHTML = '<option value="">â€” select a spreadsheet â€”</option>' +
      files.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    log(`âœ“ Loaded ${files.length} spreadsheets from your Drive`, 'lok');
    alert.innerHTML = `<div class="alert ok">âœ“ Found ${files.length} spreadsheets. Select one above.</div>`;
    setTimeout(()=>{ alert.innerHTML=''; }, 4000);
  } catch(e) {
    sel.innerHTML = '<option value="">Error loading â€” click ğŸ”„ to retry</option>';
    alert.innerHTML = `<div class="alert err">Failed to load sheets: ${e.message}</div>`;
    log('Sheets load error: ' + e.message, 'ler');
  }
}

async function loadTabs(sheetId) {
  if (!sheetId) return;
  const sel = document.getElementById('tab-sel');
  sel.innerHTML = '<option value="">Loading tabs...</option>';
  try {
    const data = await gFetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties`);
    const tabs = (data.sheets||[]).map(s=>s.properties.title);
    sel.innerHTML = '<option value="">â€” select a tab â€”</option>' + tabs.map(t=>`<option value="${t}">${t}</option>`).join('');
  } catch(e) {
    sel.innerHTML = '<option value="">Could not load tabs</option>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE TO SHEETS â€” FIX: Correct range format + error surfacing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveToSheets(items, headers) {
  const sheetId = document.getElementById('sheet-sel').value;
  if (!sheetId) throw new Error('No spreadsheet selected! Please pick one from the dropdown.');

  const customTab = document.getElementById('custom-tab').value.trim();
  const dropTab = document.getElementById('tab-sel').value;
  const tabName = customTab || dropTab;
  if (!tabName) throw new Error('No tab name! Enter a tab name or pick one from the dropdown.');

  const base = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`;

  // Ensure tab exists â€” create it if not
  const meta = await gFetch(`${base}?fields=sheets.properties`);
  const tabExists = (meta.sheets||[]).some(s=>s.properties.title===tabName);
  if (!tabExists) {
    log(`Creating new tab: "${tabName}"`, 'lok');
    await gFetch(`${base}:batchUpdate`, {
      method: 'POST',
      body: JSON.stringify({ requests:[{ addSheet:{ properties:{ title:tabName } } }] })
    });
    await loadTabs(sheetId); // refresh tab list
    // select new tab
    const t = document.getElementById('tab-sel');
    for (let o of t.options) if (o.value===tabName) { t.value=tabName; break; }
  }

  // Build rows â€” FIX: escape special chars in tab name for range
  const safeTab = tabName.replace(/'/g, "\\'");
  const append = document.getElementById('tog-append').classList.contains('on');
  const rows = [headers, ...items.map(item => headers.map(h => {
    const v = item[h];
    if (v === null || v === undefined) return '';
    if (typeof v === 'object') return JSON.stringify(v);
    return String(v);
  }))];

  const range = `'${safeTab}'!A1`;

  if (append) {
    await gFetch(`${base}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`, {
      method: 'POST',
      body: JSON.stringify({ range, majorDimension:'ROWS', values: rows })
    });
  } else {
    // Clear first, then write
    await gFetch(`${base}/values/${encodeURIComponent(range)}:clear`, { method:'POST', body:'{}' });
    await gFetch(`${base}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`, {
      method: 'PUT',
      body: JSON.stringify({ range, majorDimension:'ROWS', values: rows })
    });
  }

  const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/edit#gid=0`;
  document.getElementById('sheet-link').href = sheetUrl;
  if (document.getElementById('tog-open').classList.contains('on')) window.open(sheetUrl, '_blank');
  return sheetUrl;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN ACTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runActor() {
  if (!S.apifyKey) { openApiModal(); return; }
  if (!S.actor) { alert('Pick an actor first.'); return; }
  if (!S.token) { alert('Sign in with Google first.'); return; }

  // Build input
  let input;
  const raw = document.getElementById('raw-json').value.trim();
  if (raw) {
    try { input = JSON.parse(raw); }
    catch(e) { alert('Invalid JSON: ' + e.message); return; }
  } else {
    input = S.actor.buildInput(collectForm());
  }

  setRunning(true); clearLog();
  document.getElementById('res-card').style.display = 'none';
  setProgress(5, 'Starting job...');

  log(`â–¶ ${S.actor.name}`, 'lh');
  log('Input: ' + JSON.stringify(input).substring(0,300), 'li');

  // FIX: correct actor ID format for Apify API (use ~ not /)
  const actorSlug = S.actor.id.replace('/', '~');

  try {
    // Start the run
    const runRes = await fetch(
      `https://api.apify.com/v2/acts/${actorSlug}/runs?token=${S.apifyKey}`,
      { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(input) }
    );
    if (!runRes.ok) {
      const e = await runRes.json();
      throw new Error(e?.error?.message || `Apify returned HTTP ${runRes.status}`);
    }
    const run = await runRes.json();
    const runId = run.data.id;
    log(`âœ“ Run started â€” ID: ${runId}`, 'lok');
    setProgress(15, 'Job queued...');

    // Poll until done
    const items = await pollRun(runId);
    if (!items || items.length === 0) { log('âš  No results returned from actor.', 'lw'); setRunning(false); return; }

    // FIX: Extract correct fields including phone, address
    const headers = extractHeaders(items);
    S.results = items;
    S.headers = headers;
    log(`âœ“ Got ${items.length} results`, 'lok');
    setProgress(90, 'Saving to Google Sheets...');

    try {
      const sheetUrl = await saveToSheets(items, headers);
      log(`âœ“ Saved ${items.length} rows to Google Sheets`, 'lok');
      log(`â†’ ${sheetUrl}`, 'lok');
    } catch(sheetErr) {
      log(`âš  Sheet save failed: ${sheetErr.message}`, 'ler');
    }

    setProgress(100, 'Done!');
    showResults(items, headers);

    S.history.unshift({
      name: S.actor.name, icon: S.actor.icon,
      rows: items.length, time: new Date().toLocaleString(),
      ok: true,
      url: document.getElementById('sheet-link').href
    });

  } catch(e) {
    log(`âœ— Error: ${e.message}`, 'ler');
    S.history.unshift({ name: S.actor.name, icon: S.actor.icon, rows:0, time:new Date().toLocaleString(), ok:false });
  }

  setRunning(false);
  renderHistory();
}

// FIX: smarter header extraction â€” prioritise important fields
function extractHeaders(items) {
  const priority = ['title','name','address','phone','website','email','rating','reviewsCount','url','description','position','price','category'];
  const allKeys = [...new Set(items.flatMap(i => Object.keys(i)))];
  const pKeys = priority.filter(k => allKeys.includes(k));
  const rest = allKeys.filter(k => !priority.includes(k) && typeof items[0][k] !== 'object').slice(0, 20);
  return [...pKeys, ...rest].slice(0, 30);
}

async function pollRun(runId) {
  const steps = [20,28,36,44,52,60,68,74,80,84];
  for (let i = 0; i < 72; i++) {
    await sleep(5000);
    const res = await fetch(`https://api.apify.com/v2/actor-runs/${runId}?token=${S.apifyKey}`);
    const d = await res.json();
    const status = d.data?.status;
    setProgress(steps[Math.min(i, steps.length-1)], `${status} (${(i+1)*5}s)`);
    log(`[${(i+1)*5}s] ${status}`, 'li');

    if (status === 'SUCCEEDED') {
      const dsId = d.data.defaultDatasetId;
      const dr = await fetch(`https://api.apify.com/v2/datasets/${dsId}/items?token=${S.apifyKey}&format=json&limit=5000`);
      return await dr.json();
    }
    if (['FAILED','ABORTED','TIMED-OUT'].includes(status)) throw new Error(`Actor run ${status}`);
  }
  throw new Error('Timeout: run exceeded 6 minutes');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collectForm() {
  const out = {};
  (S.actor?.form||[]).forEach(f => {
    const el = document.getElementById('ff_'+f.key);
    if (!el) return;
    out[f.key] = el.tagName==='INPUT' && el.type==='checkbox' ? el.checked : el.value;
  });
  return out;
}

function buildForm() {
  const a = S.actor;
  document.getElementById('dyn-form').innerHTML = a.form.map(f => {
    if (f.type === 'textarea')
      return `<div class="form-group"><label>${f.label}</label><textarea id="ff_${f.key}" placeholder="${f.placeholder||''}">${f.default||''}</textarea></div>`;
    if (f.type === 'select')
      return `<div class="form-group"><label>${f.label}</label><select id="ff_${f.key}">${f.options.map(o=>`<option value="${o}"${o===f.default?' selected':''}>${o}</option>`).join('')}</select></div>`;
    if (f.type === 'number')
      return `<div class="form-group"><label>${f.label}</label><input type="number" id="ff_${f.key}" value="${f.default||''}"></div>`;
    return `<div class="form-group"><label>${f.label}</label><input type="text" id="ff_${f.key}" placeholder="${f.placeholder||''}" value="${f.default||''}"></div>`;
  }).join('');
  document.getElementById('raw-json').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults(items, headers) {
  document.getElementById('res-card').style.display = 'block';
  document.getElementById('res-count').textContent = `${items.length} rows`;
  document.getElementById('res-head').innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
  const preview = items.slice(0,100);
  document.getElementById('res-body').innerHTML = preview.map(item =>
    `<tr>${headers.map(h => {
      let v = item[h];
      if (v===null||v===undefined) v='';
      if (typeof v==='object') v=JSON.stringify(v);
      v = String(v);
      if ((h==='url'||h==='website')&&v.startsWith('http')) return `<td><a href="${v}" target="_blank">${v}</a></td>`;
      return `<td title="${v.replace(/"/g,'&quot;')}">${v}</td>`;
    }).join('')}</tr>`
  ).join('') + (items.length>100?`<tr><td colspan="${headers.length}" style="text-align:center;color:var(--muted);font-style:italic">...${items.length-100} more rows saved in Google Sheets</td></tr>`:'');
}

function dlCSV() {
  if (!S.results.length) return;
  const csv = [S.headers.join(','), ...S.results.map(r => S.headers.map(h => {
    let v = r[h];
    if (v===null||v===undefined) v='';
    if (typeof v==='object') v=JSON.stringify(v);
    return `"${String(v).replace(/"/g,'""')}"`;
  }).join(','))].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = (S.actor?.name||'data').replace(/\s+/g,'-')+'-'+Date.now()+'.csv';
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTOR BROWSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActors() {
  const g = document.getElementById('actor-grid');
  if (!visibleActors.length) {
    g.innerHTML = '<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ”</div><p>No actors found.</p></div>';
    return;
  }
  g.innerHTML = visibleActors.map(a=>`
    <div class="actor-card${S.actor?.id===a.id?' selected':''}" onclick="pickActor('${a.id}')">
      ${a.badge?'<span class="ac-badge">â­ Popular</span>':''}
      <div class="ac-icon">${a.icon}</div>
      <div class="ac-name">${a.name}</div>
      <div class="ac-id">${a.id}</div>
      <div class="ac-desc">${a.desc}</div>
      <div class="ac-tags">${a.tags.map(t=>`<span class="ac-tag">${t}</span>`).join('')}</div>
    </div>`).join('');
}

function filterActors() {
  const q = document.getElementById('actor-q').value.toLowerCase();
  visibleActors = ACTORS.filter(a =>
    (S.cat==='all'||a.cat===S.cat) &&
    (!q || a.name.toLowerCase().includes(q) || a.tags.some(t=>t.includes(q)) || a.id.includes(q))
  );
  renderActors();
}

function setCat(cat, el) {
  S.cat = cat;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  filterActors();
}

async function searchStore() {
  const q = document.getElementById('actor-q').value.trim();
  if (!q) { alert('Enter a search term first.'); return; }
  if (!S.apifyKey) { openApiModal(); return; }
  log('Searching Apify Store for: '+q, 'li');
  try {
    const r = await fetch(`https://api.apify.com/v2/store?token=${S.apifyKey}&search=${encodeURIComponent(q)}&limit=20`);
    const d = await r.json();
    if (d.data?.items?.length) {
      const extra = d.data.items.map(a=>({
        id:`${a.username}/${a.name}`, name:a.title||a.name, icon:'ğŸ”§', cat:'web',
        desc:(a.description||'No description').substring(0,120), tags:[a.username], badge:false,
        buildInput(f){ return JSON.parse(f._json||'{}'); },
        form:[{key:'_json',label:'Input JSON (check actor docs)',type:'textarea',placeholder:'{"key":"value"}'}]
      }));
      visibleActors = [...ACTORS.filter(a=>a.name.toLowerCase().includes(q.toLowerCase())), ...extra];
      renderActors();
      log(`Found ${extra.length} actors in Apify Store`, 'lok');
    } else { log('No results from store.', 'lw'); }
  } catch(e) { log('Store search error: '+e.message, 'ler'); }
}

function pickActor(id) {
  S.actor = visibleActors.find(a=>a.id===id) || ACTORS.find(a=>a.id===id);
  renderActors();
  buildForm();
  document.getElementById('ab-icon').textContent = S.actor.icon;
  document.getElementById('ab-name').textContent = S.actor.name;
  document.getElementById('ab-id').textContent = S.actor.id;
  document.getElementById('no-actor').style.display = 'none';
  document.getElementById('run-content').style.display = 'block';
  // Switch to run page
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.nav-item')[1].classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-run').classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV / HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id, el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
}

function renderHistory() {
  const el = document.getElementById('history-list');
  if (!S.history.length) { el.innerHTML='<div class="empty"><div class="ei">ğŸ“‚</div><p>No runs yet.</p></div>'; return; }
  el.innerHTML = S.history.map(h=>`
    <div class="history-item" ${h.url?`onclick="window.open('${h.url}','_blank')"`:''}>
      <div class="hi-dot ${h.ok?'ok':'err'}"></div>
      <div style="font-size:1.4rem">${h.icon}</div>
      <div><div class="hi-name">${h.name}</div><div class="hi-meta">${h.time}</div></div>
      <div class="hi-rows">${h.rows} rows</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openApiModal() {
  document.getElementById('m-api-key').value = S.apifyKey;
  document.getElementById('api-modal').classList.add('show');
}
function closeApiModal() { document.getElementById('api-modal').classList.remove('show'); }
async function confirmApiKey() {
  const k = document.getElementById('m-api-key').value.trim();
  if (!k) return;
  S.apifyKey = k; localStorage.setItem('hp_apify', k);
  document.getElementById('s-apify-key').value = k;
  updateApiDisplay();
  closeApiModal();
  // Test key
  try {
    const r = await fetch(`https://api.apify.com/v2/users/me?token=${k}`);
    const d = await r.json();
    if (d.data?.username) log(`âœ“ Apify key valid â€” user: ${d.data.username}`, 'lok');
    else log('âš  Key may be invalid', 'lw');
  } catch(e) { log('Could not verify key', 'lw'); }
}
function saveKey() {
  const k = document.getElementById('s-apify-key').value.trim();
  if (!k) return;
  S.apifyKey = k; localStorage.setItem('hp_apify', k);
  updateApiDisplay();
  alert('API key saved!');
}
function updateApiDisplay() {
  const k = S.apifyKey;
  document.getElementById('api-key-display').textContent = k ? k.substring(0,16)+'...'+k.slice(-4) : 'Not set â€” click to add';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTabModal() { document.getElementById('tab-modal').classList.add('show'); }
function closeTabModal() { document.getElementById('tab-modal').classList.remove('show'); }
function confirmTab() {
  const n = document.getElementById('m-tab').value.trim();
  if (!n) return;
  document.getElementById('custom-tab').value = n;
  closeTabModal();
  document.getElementById('m-tab').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg, cls='li') {
  const b = document.getElementById('log-box');
  b.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  b.scrollTop = b.scrollHeight;
}
function clearLog() { document.getElementById('log-box').innerHTML = ''; }
function setProgress(pct, lbl) {
  document.getElementById('prog-wrap').style.display = 'block';
  document.getElementById('prog-fill').style.width = pct + '%';
  document.getElementById('prog-lbl').textContent = lbl;
  document.getElementById('prog-pct').textContent = pct + '%';
  const s = document.getElementById('run-status');
  s.textContent = lbl; s.classList.add('show');
}
function setRunning(on) {
  const b = document.getElementById('btn-run');
  b.disabled = on;
  b.innerHTML = on ? '<div class="spin"></div><span>Running...</span>' : '<span>â–¶ Start Scraping</span>';
  if (!on) { document.getElementById('run-status').classList.remove('show'); }
}
function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }

// INIT
renderActors();
if (S.apifyKey) updateApiDisplay();
</script>
</body>
</html>
