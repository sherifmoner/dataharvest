<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harvest Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#07070f;--s1:#0d0d1a;--s2:#131320;--border:#1c1c30;--border2:#252540;--accent:#ff6b2b;--accent2:#ffaa00;--blue:#4f8ef7;--green:#22c55e;--red:#ef4444;--text:#e2e2f0;--muted:#55556e;--muted2:#8888a8}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif}
#auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(255,107,43,.08),transparent 70%)}
.auth-box{max-width:480px;width:100%;padding:32px;text-align:center}
.auth-icon{font-size:4rem;margin-bottom:24px;display:block;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.auth-box h1{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;letter-spacing:.05em;margin-bottom:8px}
.auth-box h1 em{color:var(--accent);font-style:normal}
.auth-box p{color:var(--muted2);line-height:1.7;margin-bottom:32px}
.features{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:36px;text-align:left}
.feat{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px}
.feat .fi{font-size:1.4rem;margin-bottom:6px}
.feat strong{display:block;font-size:.85rem;margin-bottom:2px}
.feat span{color:var(--muted);font-size:.75rem}
.btn-auth{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:700;font-size:1.05rem;color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .2s}
.btn-auth:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(255,107,43,.4)}
.btn-auth svg{width:24px;height:24px}
.auth-note{margin-top:14px;font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
/* APP */
#app-screen{height:100vh;flex-direction:column;display:none}
.topbar{height:58px;background:var(--s1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:.05em}
.logo em{color:var(--accent);font-style:normal}
.tsep{flex:1}
.run-badge{font-size:.72rem;font-family:'JetBrains Mono',monospace;color:var(--accent2);padding:4px 10px;background:rgba(255,170,0,.1);border:1px solid rgba(255,170,0,.2);border-radius:20px;display:none;animation:pulse 1.4s ease-in-out infinite}
.run-badge.on{display:block}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.user-chip{display:flex;align-items:center;gap:8px;padding:6px 14px 6px 6px;background:var(--s2);border:1px solid var(--border);border-radius:20px;font-size:.82rem;cursor:pointer;transition:all .2s}
.user-chip:hover{border-color:var(--red);color:var(--red)}
.av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:#000}
.content{display:flex;flex:1;overflow:hidden}
/* SIDEBAR */
.sidebar{width:248px;min-width:248px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sb-sec{padding:16px 12px 6px;font-size:.6rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);font-family:'JetBrains Mono',monospace}
.nav{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:2px 8px;border-radius:8px;cursor:pointer;font-size:.88rem;color:var(--muted2);transition:all .15s;border:1px solid transparent}
.nav:hover{background:var(--s2);color:var(--text)}
.nav.on{background:rgba(255,107,43,.1);color:var(--accent);border-color:rgba(255,107,43,.2)}
.nav .ni{width:20px;text-align:center}
.key-box{margin:8px;border:1px solid var(--border);border-radius:10px;padding:14px;background:var(--s2)}
.key-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;font-family:'JetBrains Mono',monospace}
.key-val{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--accent2);word-break:break-all;cursor:pointer;line-height:1.5}
.key-val:hover{color:var(--accent)}
.btn-key{margin-top:8px;width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.75rem;cursor:pointer;transition:all .2s}
.btn-key:hover{border-color:var(--accent);color:var(--accent)}
/* PANEL */
.panel{flex:1;overflow-y:auto;padding:24px}
.pg{display:none}.pg.on{display:block}
.pg-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.05em;margin-bottom:4px}
.pg-sub{color:var(--muted2);font-size:.85rem;margin-bottom:24px}
/* ACTOR GRID */
.search-row{display:flex;gap:10px;margin-bottom:20px}
.sw{flex:1;position:relative}
.sw input{width:100%;padding:11px 14px 11px 38px;background:var(--s1);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s}
.sw input:focus{border-color:var(--accent)}
.sw .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
.btn-s{padding:11px 16px;background:var(--s1);border:1px solid var(--border);border-radius:10px;color:var(--muted2);cursor:pointer;font-size:.85rem;transition:all .2s;font-family:'Outfit',sans-serif;white-space:nowrap}
.btn-s:hover{border-color:var(--blue);color:var(--blue)}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.pill{padding:6px 14px;background:var(--s1);border:1px solid var(--border);border-radius:20px;font-size:.78rem;color:var(--muted2);cursor:pointer;transition:all .2s;white-space:nowrap}
.pill:hover{border-color:var(--accent);color:var(--accent)}
.pill.on{background:rgba(255,107,43,.12);border-color:var(--accent);color:var(--accent)}
.ag{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.ac{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all .2s;position:relative}
.ac:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.ac.on{border-color:var(--accent);background:rgba(255,107,43,.06)}
.ac-i{font-size:1.8rem;margin-bottom:10px}
.ac-n{font-weight:600;font-size:.92rem;margin-bottom:4px}
.ac-id{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:8px}
.ac-d{font-size:.78rem;color:var(--muted2);line-height:1.5}
.ac-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px}
.ac-tag{padding:2px 8px;background:var(--s2);border:1px solid var(--border2);border-radius:4px;font-size:.65rem;color:var(--muted2)}
.ac-bdg{position:absolute;top:12px;right:12px;padding:3px 8px;border-radius:4px;font-size:.65rem;font-weight:700;background:rgba(255,107,43,.15);color:var(--accent);border:1px solid rgba(255,107,43,.3)}
/* RUN */
.rl{display:grid;grid-template-columns:1fr 380px;gap:20px}
.card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:16px}
.card h3{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:.05em;color:var(--accent);margin-bottom:18px}
.fg{margin-bottom:16px}
label{display:block;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
input[type=text],input[type=number],select,textarea{width:100%;padding:11px 13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
select option{background:var(--s1)}
textarea{resize:vertical;min-height:80px}
.hint{font-size:.72rem;color:var(--muted);margin-top:4px;font-family:'JetBrains Mono',monospace}
.actor-banner{display:flex;align-items:center;gap:14px;padding:16px;background:rgba(255,107,43,.06);border:1px solid rgba(255,107,43,.2);border-radius:10px;margin-bottom:20px}
.ab-i{font-size:2rem}
.ab-n{font-weight:700;font-size:1rem}
.ab-id{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);margin-top:2px}
.ab-ch{margin-left:auto;padding:6px 12px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.75rem;cursor:pointer;transition:all .2s}
.ab-ch:hover{border-color:var(--accent);color:var(--accent)}
.sr{display:flex;gap:8px}
.sr select{flex:1}
.bi{padding:11px 13px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted2);cursor:pointer;font-size:.9rem;transition:all .2s}
.bi:hover{border-color:var(--blue);color:var(--blue)}
.btn-run{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#000;font-family:'Outfit',sans-serif;font-weight:700;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;margin-top:4px}
.btn-run:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,107,43,.35)}
.btn-run:disabled{opacity:.5;cursor:not-allowed}
.log{height:200px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:.72rem;line-height:1.8}
.li{color:var(--muted2)}.lok{color:var(--green)}.ler{color:var(--red)}.lw{color:var(--accent2)}.lh{color:var(--accent)}
.pw{margin-top:14px}
.pl{display:flex;justify-content:space-between;font-size:.72rem;color:var(--muted);margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.pt{height:6px;background:var(--border);border-radius:3px}
.pf{height:6px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;width:0%;transition:width .4s}
.rh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.rc{padding:4px 12px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);border-radius:20px;font-size:.75rem;color:var(--green)}
.bc{padding:8px 14px;background:transparent;border:1px solid var(--border2);border-radius:7px;color:var(--muted2);font-family:'Outfit',sans-serif;font-size:.78rem;cursor:pointer;transition:all .2s}
.bc:hover{border-color:var(--green);color:var(--green)}
.tw{overflow-x:auto;max-height:360px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{padding:9px 12px;background:var(--bg);border-bottom:1px solid var(--border);color:var(--muted);font-size:.68rem;text-transform:uppercase;letter-spacing:.06em;font-weight:400;font-family:'JetBrains Mono',monospace;text-align:left;position:sticky;top:0;white-space:nowrap}
td{padding:9px 12px;border-bottom:1px solid var(--border);color:var(--text);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:rgba(255,255,255,.02)}
td a{color:var(--blue);text-decoration:none}
.sl{display:inline-flex;align-items:center;gap:8px;margin-top:14px;padding:10px 18px;background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.25);border-radius:8px;color:var(--blue);text-decoration:none;font-size:.85rem;transition:all .2s}
.sl:hover{background:rgba(79,142,247,.15)}
/* HISTORY */
.hi{display:flex;align-items:center;gap:16px;padding:16px;background:var(--s1);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;transition:border-color .2s}
.hi:hover{border-color:var(--border2)}
.hin{font-weight:600;font-size:.9rem;margin-bottom:2px}
.him{font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
.hir{margin-left:auto;padding:4px 12px;background:var(--s2);border:1px solid var(--border2);border-radius:20px;font-size:.75rem;color:var(--muted2)}
.hid{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.hid.ok{background:var(--green)}.hid.err{background:var(--red)}
/* SETTINGS */
.sc{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:16px}
.sc h3{font-weight:600;font-size:1rem;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.strow{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.strow:last-child{border-bottom:none}
.stl{font-size:.88rem}
.sts{font-size:.75rem;color:var(--muted);margin-top:2px}
.tgl{width:44px;height:24px;background:var(--border2);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.tgl.on{background:var(--green)}
.tgl::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .2s}
.tgl.on::after{left:23px}
/* MODAL */
.mb{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.mb.on{display:flex}
.mo{background:var(--s1);border:1px solid var(--border2);border-radius:16px;padding:28px;width:100%;max-width:500px;margin:20px}
.mo h3{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:.05em;margin-bottom:18px}
.mbtns{display:flex;gap:10px;margin-top:20px}
.bc2{flex:1;padding:11px;background:transparent;border:1px solid var(--border2);border-radius:8px;color:var(--muted2);cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s}
.bc2:hover{border-color:var(--red);color:var(--red)}
.bs{flex:1;padding:11px;background:var(--accent);border:none;border-radius:8px;color:#000;font-family:'Outfit',sans-serif;font-weight:700;cursor:pointer;transition:all .2s}
.bs:hover{background:var(--accent2)}
.spin{width:18px;height:18px;border:2px solid rgba(0,0,0,.25);border-top-color:#000;border-radius:50%;animation:sp .5s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .ei{font-size:3rem;margin-bottom:16px}
.alert{padding:12px 16px;border-radius:8px;font-size:.82rem;margin-bottom:14px}
.alert.ok{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
.alert.err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
.alert.info{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);color:#93c5fd}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
</style>
</head>
<body>

<!-- â•â• AUTH â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <span class="auth-icon">âš¡</span>
    <h1>Harvest <em>Pro</em></h1>
    <p>Full Apify scraping center. Pick any actor, configure city & niche, results auto-saved to your Google Sheets.</p>
    <div class="features">
      <div class="feat"><div class="fi">ğŸ—ºï¸</div><strong>Any Apify Actor</strong><span>Google Maps, Search, Social & more</span></div>
      <div class="feat"><div class="fi">ğŸ“Š</div><strong>Auto Google Sheets</strong><span>Your sheets load automatically</span></div>
      <div class="feat"><div class="fi">ğŸ“</div><strong>Full Data</strong><span>Phone, address, email, website</span></div>
      <div class="feat"><div class="fi">ğŸ”‘</div><strong>Key Manager</strong><span>Swap Apify API keys anytime</span></div>
    </div>
    <button class="btn-auth" onclick="doAuth()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Sign in with Google
    </button>
    <p class="auth-note"> You will be redirected to Google, then back here automatically , Welcome To Harvest Pro</p>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div id="app-screen">
  <div class="topbar">
    <div class="logo">Harvest <em>Pro</em></div>
    <div class="tsep"></div>
    <div class="run-badge" id="run-badge">â³ Running...</div>
    <div class="user-chip" onclick="signOut()">
      <div class="av" id="uav">?</div>
      <span id="uem">...</span>
      <span style="color:var(--muted);margin-left:4px">âœ• Sign out</span>
    </div>
  </div>
  <div class="content">
    <div class="sidebar">
      <div class="sb-sec">Navigation</div>
      <div class="nav on" onclick="gp('actors',this)"><span class="ni">ğŸ”</span>Actor Browser</div>
      <div class="nav" onclick="gp('run',this)"><span class="ni">â–¶ï¸</span>Run & Configure</div>
      <div class="nav" onclick="gp('history',this)"><span class="ni">ğŸ“‚</span>Run History</div>
      <div class="nav" onclick="gp('settings',this)"><span class="ni">âš™ï¸</span>Settings</div>
      <div style="margin-top:auto">
        <div class="sb-sec">Apify API Key</div>
        <div class="key-box">
          <div class="key-lbl">Active Key</div>
          <div class="key-val" id="key-disp" onclick="okm()">Not set â€” click to add</div>
          <button class="btn-key" onclick="okm()">ğŸ”‘ Change API Key</button>
        </div>
      </div>
    </div>

    <div class="panel">

      <!-- ACTORS -->
      <div id="pg-actors" class="pg on">
        <div class="pg-title">Actor Browser</div>
        <div class="pg-sub">Click any actor to configure and run it.</div>
        <div class="search-row">
          <div class="sw"><span class="si">ğŸ”</span><input type="text" id="aq" placeholder="Search: google maps, instagram, amazon..." oninput="fa()"></div>
          <button class="btn-s" onclick="searchStore()">ğŸ”„ Search Apify Store</button>
        </div>
        <div class="pills">
          <div class="pill on" onclick="sc('all',this)">All</div>
          <div class="pill" onclick="sc('maps',this)">ğŸ—º Maps & Places</div>
          <div class="pill" onclick="sc('search',this)">ğŸ” Search Engines</div>
          <div class="pill" onclick="sc('social',this)">ğŸ“± Social Media</div>
          <div class="pill" onclick="sc('ecommerce',this)">ğŸ› E-Commerce</div>
          <div class="pill" onclick="sc('leads',this)">ğŸ‘¥ Leads</div>
          <div class="pill" onclick="sc('web',this)">ğŸŒ Web Scraping</div>
        </div>
        <div class="ag" id="ag"></div>
      </div>

      <!-- RUN -->
      <div id="pg-run" class="pg">
        <div class="pg-title">Run & Configure</div>
        <div class="pg-sub">Configure your job, pick a Google Sheet, and scrape.</div>
        <div id="no-actor" class="empty"><div class="ei">ğŸ‘†</div><p>Select an actor from <strong>Actor Browser</strong> first.</p></div>
        <div id="run-content" style="display:none">
          <div class="actor-banner">
            <div class="ab-i" id="ab-i">âš™ï¸</div>
            <div><div class="ab-n" id="ab-n">-</div><div class="ab-id" id="ab-id">-</div></div>
            <button class="ab-ch" onclick="gp('actors',document.querySelector('.nav'))">â† Change Actor</button>
          </div>
          <div class="rl">
            <!-- LEFT -->
            <div>
              <div class="card">
                <h3>âš™ Actor Configuration</h3>
                <div id="dform"></div>
                <details style="margin-top:16px">
                  <summary style="cursor:pointer;font-size:.8rem;color:var(--muted2);user-select:none">â–¸ Advanced: Raw JSON input (overrides form)</summary>
                  <div style="margin-top:10px">
                    <textarea id="rjson" placeholder='{"searchStringsArray":["coffee in Cairo"],"maxCrawledPlacesPerSearch":50}'></textarea>
                  </div>
                </details>
              </div>
              <div class="card" id="res-card" style="display:none">
                <div class="rh">
                  <h3 style="margin:0">ğŸ“Š Results</h3>
                  <div style="display:flex;gap:8px;align-items:center">
                    <span class="rc" id="rcount">0 rows</span>
                    <button class="bc" onclick="dlcsv()">â¬‡ CSV</button>
                  </div>
                </div>
                <div class="tw"><table><thead id="rhead"></thead><tbody id="rbody"></tbody></table></div>
                <a class="sl" id="slink" href="#" target="_blank">ğŸ“Š Open in Google Sheets</a>
              </div>
            </div>
            <!-- RIGHT -->
            <div>
              <div class="card">
                <h3>ğŸ“Š Google Sheets</h3>
                <div id="sh-alert"></div>
                <div class="fg">
                  <label>Spreadsheet (from your Google account)</label>
                  <div class="sr">
                    <select id="sh-sel" onchange="loadTabs(this.value)"><option value="">Loading your sheets...</option></select>
                    <button class="bi" onclick="loadSheets()" title="Refresh">ğŸ”„</button>
                  </div>
                </div>
                <div class="fg">
                  <label>Tab</label>
                  <div class="sr">
                    <select id="tab-sel"><option value="">Select spreadsheet first</option></select>
                    <button class="bi" onclick="otm()" title="New tab">ï¼‹</button>
                  </div>
                </div>
                <div class="fg">
                  <label>Or type a new tab name</label>
                  <input type="text" id="ctab" placeholder="e.g. Cairo Leads July 2025">
                  <div class="hint">This overrides the tab dropdown if filled</div>
                </div>
              </div>
              <div class="card">
                <h3>â–¶ Execute</h3>
                <button class="btn-run" id="btn-run" onclick="runActor()"><span>â–¶ Start Scraping</span></button>
                <div class="pw" id="pw" style="display:none">
                  <div class="pl"><span id="plbl">Starting...</span><span id="ppct">0%</span></div>
                  <div class="pt"><div class="pf" id="pf"></div></div>
                </div>
                <div style="margin-top:14px">
                  <label>Live Log</label>
                  <div class="log" id="logbox"><span class="li">// Ready â€” configure above and press Start.</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div id="pg-history" class="pg">
        <div class="pg-title">Run History</div>
        <div class="pg-sub">All scraping jobs this session.</div>
        <div id="hlist"><div class="empty"><div class="ei">ğŸ“‚</div><p>No runs yet.</p></div></div>
      </div>

      <!-- SETTINGS -->
      <div id="pg-settings" class="pg">
        <div class="pg-title">Settings</div>
        <div class="pg-sub">Manage API key and preferences.</div>
        <div class="sc">
          <h3>ğŸ”‘ Apify API Key</h3>
          <div class="fg">
            <label>API Key</label>
            <input type="text" id="s-key" placeholder="apify_api_...">
            <div class="hint">Get it: console.apify.com â†’ Settings â†’ Integrations â†’ API tokens</div>
          </div>
          <button class="btn-run" style="max-width:160px;margin-top:0" onclick="saveKey()">Save Key</button>
        </div>
        <div class="sc">
          <h3>âš™ Preferences</h3>
          <div class="strow">
            <div><div class="stl">Auto-open sheet after run</div><div class="sts">Opens Google Sheets when scraping completes</div></div>
            <div class="tgl" id="tog-open" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="strow">
            <div><div class="stl">Append rows (don't overwrite)</div><div class="sts">Adds data below existing rows</div></div>
            <div class="tgl on" id="tog-app" onclick="this.classList.toggle('on')"></div>
          </div>
        </div>
      </div>

    </div><!-- /panel -->
  </div>
</div>

<!-- API KEY MODAL -->
<div class="mb" id="km">
  <div class="mo">
    <h3>ğŸ”‘ Set Apify API Key</h3>
    <div class="fg">
      <label>Apify API Key</label>
      <input type="text" id="m-key" placeholder="apify_api_...">
      <div class="hint">console.apify.com â†’ Settings â†’ Integrations â†’ API tokens</div>
    </div>
    <div class="mbtns">
      <button class="bc2" onclick="ckm()">Cancel</button>
      <button class="bs" onclick="saveKeyModal()">Save & Test</button>
    </div>
  </div>
</div>

<!-- NEW TAB MODAL -->
<div class="mb" id="tm">
  <div class="mo">
    <h3>â• New Tab Name</h3>
    <div class="fg">
      <label>Tab Name</label>
      <input type="text" id="m-tab" placeholder="e.g. Cairo Coffee Shops July 2025">
    </div>
    <div class="mbtns">
      <button class="bc2" onclick="ctm()">Cancel</button>
      <button class="bs" onclick="confirmTab()">Use This Name</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” update CLIENT_ID if you ever recreate OAuth creds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID = '633930604616-oda4vnsest0uhg8ivci8uv2j3g7iovh7.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  token: null,
  apifyKey: localStorage.getItem('hp_apify') || '',
  actor: null,
  results: [], headers: [],
  history: [],
  cat: 'all'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OAUTH â€” REDIRECT FLOW (works on GitHub Pages)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doAuth() {
  // Save current URL so we can return here exactly
  const here = window.location.href.split('#')[0];
  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: here,
    response_type: 'token',
    scope: SCOPES,
    prompt: 'consent',
    include_granted_scopes: 'true'
  });
  // Full redirect â€” same tab, no popup
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
}

// On page load, check if Google redirected back with a token in the hash
function checkAuthRedirect() {
  const hash = window.location.hash;
  if (!hash || !hash.includes('access_token')) return false;

  const p = new URLSearchParams(hash.replace('#',''));
  const token = p.get('access_token');
  if (!token) return false;

  // Clean the URL so refreshing doesn't reuse the token
  history.replaceState(null, '', window.location.pathname);
  S.token = token;
  // Save token temporarily in sessionStorage so it survives minor re-renders
  sessionStorage.setItem('hp_token', token);
  return true;
}

async function initApp() {
  const app = document.getElementById('app-screen');
  document.getElementById('auth-screen').style.display = 'none';
  app.style.cssText = 'display:flex; flex-direction:column; height:100vh';

  // Load user info
  try {
    const u = await gf('https://www.googleapis.com/oauth2/v2/userinfo');
    document.getElementById('uem').textContent = u.email || u.name || 'Signed in';
    document.getElementById('uav').textContent = (u.name || u.email || '?')[0].toUpperCase();
  } catch(e) {
    document.getElementById('uem').textContent = 'Signed in';
  }

  // Load API key
  if (S.apifyKey) {
    updateKeyDisplay();
    document.getElementById('s-key').value = S.apifyKey;
  }

  // Auto-load sheets
  await loadSheets();
  renderActors();
}

function signOut() {
  S.token = null;
  sessionStorage.removeItem('hp_token');
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE API FETCH HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function gf(url, opts = {}) {
  const res = await fetch(url, {
    ...opts,
    headers: {
      'Authorization': 'Bearer ' + S.token,
      'Content-Type': 'application/json',
      ...(opts.headers || {})
    }
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error?.message || 'HTTP ' + res.status);
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD SHEETS â€” lists ALL sheets from Drive
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSheets() {
  const sel = document.getElementById('sh-sel');
  const al = document.getElementById('sh-alert');
  sel.innerHTML = '<option value="">Loading your Google Sheets...</option>';
  al.innerHTML = '';
  try {
    const data = await gf(
      'https://www.googleapis.com/drive/v3/files' +
      '?q=' + encodeURIComponent("mimeType='application/vnd.google-apps.spreadsheet' and trashed=false") +
      '&fields=files(id,name)&pageSize=100&orderBy=modifiedTime+desc'
    );
    const files = data.files || [];
    if (!files.length) {
      sel.innerHTML = '<option value="">No spreadsheets found in Drive</option>';
      al.innerHTML = '<div class="alert info">No Google Sheets found. Go to sheets.google.com, create one, then click ğŸ”„</div>';
      return;
    }
    sel.innerHTML = '<option value="">â€” choose a spreadsheet â€”</option>' +
      files.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    al.innerHTML = `<div class="alert ok">âœ“ ${files.length} spreadsheets loaded from your Google account</div>`;
    setTimeout(() => { al.innerHTML = ''; }, 3500);
    log(`âœ“ Loaded ${files.length} spreadsheets`, 'lok');
  } catch(e) {
    sel.innerHTML = '<option value="">Failed â€” click ğŸ”„ to retry</option>';
    al.innerHTML = `<div class="alert err">Could not load sheets: ${e.message}</div>`;
    log('Sheet load error: ' + e.message, 'ler');
  }
}

async function loadTabs(sheetId) {
  if (!sheetId) return;
  const sel = document.getElementById('tab-sel');
  sel.innerHTML = '<option value="">Loading tabs...</option>';
  try {
    const data = await gf(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties`);
    const tabs = (data.sheets || []).map(s => s.properties.title);
    sel.innerHTML = '<option value="">â€” choose a tab â€”</option>' +
      tabs.map(t => `<option value="${t}">${t}</option>`).join('');
  } catch(e) {
    sel.innerHTML = '<option value="">Could not load tabs</option>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE TO SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveToSheets(items, headers) {
  const sheetId = document.getElementById('sh-sel').value;
  if (!sheetId) throw new Error('Please select a spreadsheet from the dropdown first.');

  const ctab = document.getElementById('ctab').value.trim();
  const dtab = document.getElementById('tab-sel').value;
  const tabName = ctab || dtab;
  if (!tabName) throw new Error('Please select or type a tab name.');

  const base = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`;

  // Create tab if it doesn't exist
  const meta = await gf(`${base}?fields=sheets.properties`);
  const exists = (meta.sheets || []).some(s => s.properties.title === tabName);
  if (!exists) {
    log(`Creating new tab: "${tabName}"...`, 'li');
    await gf(`${base}:batchUpdate`, {
      method: 'POST',
      body: JSON.stringify({ requests: [{ addSheet: { properties: { title: tabName } } }] })
    });
    await loadTabs(sheetId);
  }

  // Flatten all values to strings (handles nested objects, nulls, etc.)
  const flatten = v => {
    if (v === null || v === undefined) return '';
    if (typeof v === 'object') return JSON.stringify(v);
    return String(v);
  };

  const rows = [
    headers,
    ...items.map(item => headers.map(h => flatten(item[h])))
  ];

  const append = document.getElementById('tog-app').classList.contains('on');
  const encTab = encodeURIComponent(`${tabName}!A1`);

  if (append) {
    await gf(`${base}/values/${encTab}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
      method: 'POST',
      body: JSON.stringify({ values: rows })
    });
  } else {
    // Clear then write
    await gf(`${base}/values/${encTab}:clear`, { method: 'POST', body: '{}' });
    await gf(`${base}/values/${encTab}?valueInputOption=RAW`, {
      method: 'PUT',
      body: JSON.stringify({ values: rows })
    });
  }

  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
  document.getElementById('slink').href = url;
  if (document.getElementById('tog-open').classList.contains('on')) window.open(url, '_blank');
  return url;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTOR CATALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACTORS = [
  {
    id: 'compass/crawler-google-places',
    name: 'Google Maps Scraper', icon: 'ğŸ—ºï¸', cat: 'maps', badge: true,
    desc: 'Scrapes Google Maps. Returns: name, address, phone, website, rating, reviews, coordinates, hours.',
    tags: ['maps','phone','address','leads'],
    buildInput(f) {
      const list = (f.niche||'').split('\n').map(s=>s.trim()).filter(Boolean);
      const city = (f.city||'').trim();
      return {
        searchStringsArray: list.map(q => city ? `${q} in ${city}` : q),
        maxCrawledPlacesPerSearch: parseInt(f.max)||50,
        language: f.lang||'en',
        maxImages: 0,
        maxReviews: 0,
        includeWebResults: false
      };
    },
    form: [
      {k:'niche', l:'Business Type / Niche (one per line)', t:'textarea', p:'coffee shops\nrestaurants\ngyms\ndentists'},
      {k:'city',  l:'City / Location', t:'text', p:'Cairo, Egypt'},
      {k:'max',   l:'Max Results Per Query', t:'number', d:'50'},
      {k:'lang',  l:'Language', t:'select', opts:['en','ar','fr','de','es'], d:'en'}
    ]
  },
  {
    id: 'apify/google-search-scraper',
    name: 'Google Search Scraper', icon: 'ğŸ”', cat: 'search', badge: true,
    desc: 'Scrapes Google search results: title, URL, description, position.',
    tags: ['google','seo','serp'],
    buildInput(f) {
      return {
        queries: (f.q||'').split('\n').map(s=>s.trim()).filter(Boolean).join('\n'),
        maxPagesPerQuery: parseInt(f.pages)||1,
        resultsPerPage: parseInt(f.rpp)||10,
        countryCode: f.country||'eg',
        languageCode: f.lang||'en'
      };
    },
    form: [
      {k:'q',       l:'Search Queries (one per line)', t:'textarea', p:'best restaurants Cairo\nmarketing agencies Egypt'},
      {k:'pages',   l:'Pages Per Query', t:'number', d:'1'},
      {k:'rpp',     l:'Results Per Page', t:'select', opts:['10','20','50','100'], d:'10'},
      {k:'country', l:'Country', t:'select', opts:['eg','us','gb','ae','sa','fr','de'], d:'eg'},
      {k:'lang',    l:'Language', t:'select', opts:['en','ar','fr','de'], d:'en'}
    ]
  },
  {
    id: 'apify/instagram-scraper',
    name: 'Instagram Scraper', icon: 'ğŸ“¸', cat: 'social',
    desc: 'Scrapes Instagram profiles and posts: followers, bio, posts, links.',
    tags: ['instagram','social','influencer'],
    buildInput(f) {
      return {
        directUrls: (f.urls||'').split('\n').map(s=>s.trim()).filter(Boolean),
        resultsLimit: parseInt(f.max)||50
      };
    },
    form: [
      {k:'urls', l:'Instagram URLs (one per line)', t:'textarea', p:'https://www.instagram.com/username/\nhttps://www.instagram.com/explore/tags/cairo/'},
      {k:'max',  l:'Max Results', t:'number', d:'50'}
    ]
  },
  {
    id: 'apify/twitter-scraper',
    name: 'Twitter / X Scraper', icon: 'ğŸ¦', cat: 'social',
    desc: 'Scrapes tweets and profiles from Twitter/X.',
    tags: ['twitter','x','social'],
    buildInput(f) {
      return {
        searchTerms: (f.terms||'').split('\n').map(s=>s.trim()).filter(Boolean),
        maxTweets: parseInt(f.max)||100
      };
    },
    form: [
      {k:'terms', l:'Search Terms / Hashtags (one per line)', t:'textarea', p:'#cairo\nEgypt startups'},
      {k:'max',   l:'Max Tweets', t:'number', d:'100'}
    ]
  },
  {
    id: 'apify/amazon-product-scraper',
    name: 'Amazon Product Scraper', icon: 'ğŸ“¦', cat: 'ecommerce', badge: true,
    desc: 'Scrapes Amazon: title, price, ASIN, rating, reviews, images.',
    tags: ['amazon','products','prices'],
    buildInput(f) {
      return { keywords: f.kw||'', maxItems: parseInt(f.max)||50, country: f.country||'US' };
    },
    form: [
      {k:'kw',      l:'Search Keywords', t:'text', p:'wireless earbuds'},
      {k:'max',     l:'Max Products', t:'number', d:'50'},
      {k:'country', l:'Amazon Site', t:'select', opts:['US','UK','DE','FR','AE','SA'], d:'US'}
    ]
  },
  {
    id: 'apify/yelp-scraper',
    name: 'Yelp Business Scraper', icon: 'â­', cat: 'leads', badge: true,
    desc: 'Scrapes Yelp: name, address, phone, website, rating, category.',
    tags: ['yelp','leads','phone','address'],
    buildInput(f) {
      return { searchTerms: f.niche||'', location: f.city||'', maxItems: parseInt(f.max)||50 };
    },
    form: [
      {k:'niche', l:'Business Type / Niche', t:'text', p:'restaurants'},
      {k:'city',  l:'City / Location', t:'text', p:'Cairo'},
      {k:'max',   l:'Max Results', t:'number', d:'50'}
    ]
  },
  {
    id: 'apify/booking-scraper',
    name: 'Booking.com Scraper', icon: 'ğŸ¨', cat: 'ecommerce',
    desc: 'Scrapes hotels: name, price, rating, location, amenities.',
    tags: ['hotels','travel','prices'],
    buildInput(f) {
      return { search: f.dest||'', checkIn: f.ci||'', checkOut: f.co||'', maxResults: parseInt(f.max)||30 };
    },
    form: [
      {k:'dest', l:'Destination', t:'text', p:'Cairo, Egypt'},
      {k:'ci',   l:'Check-in Date', t:'text', p:'2025-08-01'},
      {k:'co',   l:'Check-out Date', t:'text', p:'2025-08-05'},
      {k:'max',  l:'Max Hotels', t:'number', d:'30'}
    ]
  },
  {
    id: 'apify/web-scraper',
    name: 'Universal Web Scraper', icon: 'ğŸŒ', cat: 'web',
    desc: 'Crawl any website: extract text, links, structured data.',
    tags: ['web','crawler','general'],
    buildInput(f) {
      return {
        startUrls: (f.urls||'').split('\n').map(s=>s.trim()).filter(Boolean).map(u=>({url:u})),
        maxCrawlPages: parseInt(f.pages)||10,
        maxCrawlDepth: parseInt(f.depth)||2
      };
    },
    form: [
      {k:'urls',  l:'Start URLs (one per line)', t:'textarea', p:'https://example.com'},
      {k:'pages', l:'Max Pages', t:'number', d:'10'},
      {k:'depth', l:'Crawl Depth', t:'number', d:'2'}
    ]
  }
];

let VA = [...ACTORS];

function renderActors() {
  const g = document.getElementById('ag');
  if (!VA.length) { g.innerHTML = '<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ”</div><p>No actors found.</p></div>'; return; }
  g.innerHTML = VA.map(a => `
    <div class="ac${S.actor?.id===a.id?' on':''}" onclick="pickActor('${a.id}')">
      ${a.badge?'<span class="ac-bdg">â­ Popular</span>':''}
      <div class="ac-i">${a.icon}</div>
      <div class="ac-n">${a.name}</div>
      <div class="ac-id">${a.id}</div>
      <div class="ac-d">${a.desc}</div>
      <div class="ac-tags">${a.tags.map(t=>`<span class="ac-tag">${t}</span>`).join('')}</div>
    </div>`).join('');
}

function fa() {
  const q = document.getElementById('aq').value.toLowerCase();
  VA = ACTORS.filter(a =>
    (S.cat==='all'||a.cat===S.cat) &&
    (!q || a.name.toLowerCase().includes(q) || a.tags.some(t=>t.includes(q)) || a.id.includes(q))
  );
  renderActors();
}

function sc(cat, el) {
  S.cat = cat;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));
  el.classList.add('on');
  fa();
}

async function searchStore() {
  const q = document.getElementById('aq').value.trim();
  if (!q) { alert('Enter a search term first.'); return; }
  if (!S.apifyKey) { okm(); return; }
  log('Searching Apify Store...', 'li');
  try {
    const r = await fetch(`https://api.apify.com/v2/store?token=${S.apifyKey}&search=${encodeURIComponent(q)}&limit=20`);
    const d = await r.json();
    if (d.data?.items?.length) {
      const extra = d.data.items.map(a => ({
        id: `${a.username}/${a.name}`, name: a.title||a.name, icon:'ğŸ”§', cat:'web', badge:false,
        desc: (a.description||'').substring(0,120),
        tags: [a.username],
        buildInput(f) { try { return JSON.parse(f.raw||'{}'); } catch(e) { return {}; } },
        form: [{k:'raw', l:'Input JSON (check actor docs for schema)', t:'textarea', p:'{"key":"value"}'}]
      }));
      VA = [...ACTORS.filter(a=>a.name.toLowerCase().includes(q.toLowerCase())), ...extra];
      renderActors();
      log(`Found ${extra.length} actors in Apify Store`, 'lok');
    } else { log('No results found in store.', 'lw'); }
  } catch(e) { log('Store search error: '+e.message, 'ler'); }
}

function pickActor(id) {
  S.actor = VA.find(a=>a.id===id) || ACTORS.find(a=>a.id===id);
  if (!S.actor) return;
  renderActors();
  // Build form
  document.getElementById('dform').innerHTML = S.actor.form.map(f => {
    const id2 = 'ff_'+f.k;
    if (f.t==='textarea') return `<div class="fg"><label>${f.l}</label><textarea id="${id2}" placeholder="${f.p||''}">${f.d||''}</textarea></div>`;
    if (f.t==='select') return `<div class="fg"><label>${f.l}</label><select id="${id2}">${f.opts.map(o=>`<option value="${o}"${o===f.d?' selected':''}>${o}</option>`).join('')}</select></div>`;
    return `<div class="fg"><label>${f.l}</label><input type="${f.t==='number'?'number':'text'}" id="${id2}" placeholder="${f.p||''}" value="${f.d||''}"></div>`;
  }).join('');
  document.getElementById('rjson').value = '';
  document.getElementById('ab-i').textContent = S.actor.icon;
  document.getElementById('ab-n').textContent = S.actor.name;
  document.getElementById('ab-id').textContent = S.actor.id;
  document.getElementById('no-actor').style.display = 'none';
  document.getElementById('run-content').style.display = 'block';
  // Go to run page
  document.querySelectorAll('.nav').forEach(n=>n.classList.remove('on'));
  document.querySelectorAll('.nav')[1].classList.add('on');
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.getElementById('pg-run').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN ACTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runActor() {
  if (!S.apifyKey) { okm(); return; }
  if (!S.actor) { alert('Select an actor first.'); return; }
  if (!S.token) { alert('Please sign in with Google.'); return; }

  // Build input
  let input;
  const raw = document.getElementById('rjson').value.trim();
  if (raw) {
    try { input = JSON.parse(raw); } catch(e) { alert('Invalid JSON: '+e.message); return; }
  } else {
    const formVals = {};
    S.actor.form.forEach(f => {
      const el = document.getElementById('ff_'+f.k);
      if (el) formVals[f.k] = el.value;
    });
    input = S.actor.buildInput(formVals);
  }

  setRunning(true); clearLog();
  document.getElementById('res-card').style.display = 'none';
  prog(5, 'Starting job...');

  log('â–¶ ' + S.actor.name, 'lh');
  log('Input: ' + JSON.stringify(input).substring(0,400), 'li');

  const slug = S.actor.id.replace('/', '~');

  try {
    const rr = await fetch(`https://api.apify.com/v2/acts/${slug}/runs?token=${S.apifyKey}`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(input)
    });
    if (!rr.ok) {
      const e = await rr.json();
      throw new Error(e?.error?.message || 'Apify HTTP '+rr.status);
    }
    const runData = await rr.json();
    const runId = runData.data.id;
    log('âœ“ Run started â€” ID: '+runId, 'lok');
    prog(15, 'Queued...');

    // Poll
    const items = await pollRun(runId);
    if (!items || items.length === 0) { log('âš  Actor returned no results.', 'lw'); setRunning(false); return; }

    // Smart headers â€” put important fields first
    const important = ['title','name','address','phone','phoneNumber','website','email','rating','totalScore','reviewsCount','url','description','price','position','category','city','country'];
    const allKeys = [...new Set(items.flatMap(i=>Object.keys(i)))];
    const first = important.filter(k=>allKeys.includes(k));
    const rest = allKeys.filter(k=>!important.includes(k)&&typeof items[0][k]!=='object'&&!Array.isArray(items[0][k]));
    const headers = [...first, ...rest].slice(0,35);

    S.results = items; S.headers = headers;
    prog(88, 'Saving to Google Sheets...');

    try {
      const url = await saveToSheets(items, headers);
      log(`âœ“ Saved ${items.length} rows â†’ "${document.getElementById('ctab').value || document.getElementById('tab-sel').value}"`, 'lok');
      log('â†’ ' + url, 'lok');
    } catch(se) {
      log('âš  Sheet save failed: ' + se.message, 'ler');
    }

    prog(100, 'Done!');
    showResults(items, headers);

    S.history.unshift({
      name: S.actor.name, icon: S.actor.icon,
      rows: items.length, time: new Date().toLocaleString(),
      ok: true, url: document.getElementById('slink').href
    });

  } catch(e) {
    log('âœ— ' + e.message, 'ler');
    S.history.unshift({ name:S.actor.name, icon:S.actor.icon, rows:0, time:new Date().toLocaleString(), ok:false });
  }

  setRunning(false);
  renderHistory();
}

async function pollRun(runId) {
  const steps = [20,28,36,44,52,60,68,74,80,84];
  for (let i = 0; i < 72; i++) {
    await sleep(5000);
    const r = await fetch(`https://api.apify.com/v2/actor-runs/${runId}?token=${S.apifyKey}`);
    const d = await r.json();
    const status = d.data?.status;
    prog(steps[Math.min(i,steps.length-1)], `${status} (${(i+1)*5}s)`);
    log(`[${(i+1)*5}s] ${status}`, 'li');
    if (status==='SUCCEEDED') {
      const dsId = d.data.defaultDatasetId;
      const dr = await fetch(`https://api.apify.com/v2/datasets/${dsId}/items?token=${S.apifyKey}&format=json&limit=5000`);
      return dr.json();
    }
    if (['FAILED','ABORTED','TIMED-OUT'].includes(status)) throw new Error('Actor run '+status);
  }
  throw new Error('Timeout: run exceeded 6 minutes');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults(items, headers) {
  document.getElementById('res-card').style.display = 'block';
  document.getElementById('rcount').textContent = items.length + ' rows';
  document.getElementById('rhead').innerHTML = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  const flat = v => { if(v===null||v===undefined) return ''; if(typeof v==='object') return JSON.stringify(v); return String(v); };
  document.getElementById('rbody').innerHTML = items.slice(0,100).map(item =>
    '<tr>'+headers.map(h=>{
      const v = flat(item[h]);
      if((h==='url'||h==='website')&&v.startsWith('http')) return `<td><a href="${v}" target="_blank">${v}</a></td>`;
      return `<td title="${v.replace(/"/g,'&quot;')}">${v}</td>`;
    }).join('')+'</tr>'
  ).join('') + (items.length>100?`<tr><td colspan="${headers.length}" style="text-align:center;color:var(--muted);font-style:italic">...${items.length-100} more rows saved in Google Sheets</td></tr>`:'');
}

function dlcsv() {
  if (!S.results.length) return;
  const flat = v => { if(v===null||v===undefined) return ''; if(typeof v==='object') return JSON.stringify(v); return String(v); };
  const csv = [S.headers, ...S.results.map(r=>S.headers.map(h=>flat(r[h])).map(v=>`"${v.replace(/"/g,'""')}"`))]
    .map(r=>r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = (S.actor?.name||'data').replace(/\s+/g,'-')+'-'+Date.now()+'.csv';
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const el = document.getElementById('hlist');
  if (!S.history.length) { el.innerHTML='<div class="empty"><div class="ei">ğŸ“‚</div><p>No runs yet.</p></div>'; return; }
  el.innerHTML = S.history.map(h=>`
    <div class="hi" ${h.url?`onclick="window.open('${h.url}','_blank')"`:''}>
      <div class="hid ${h.ok?'ok':'err'}"></div>
      <div style="font-size:1.4rem">${h.icon}</div>
      <div><div class="hin">${h.name}</div><div class="him">${h.time}</div></div>
      <div class="hir">${h.rows} rows</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gp(id, el) {
  document.querySelectorAll('.nav').forEach(n=>n.classList.remove('on'));
  if (el) el.classList.add('on');
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.getElementById('pg-'+id).classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function okm() { document.getElementById('m-key').value=S.apifyKey; document.getElementById('km').classList.add('on'); }
function ckm() { document.getElementById('km').classList.remove('on'); }
async function saveKeyModal() {
  const k = document.getElementById('m-key').value.trim();
  if (!k) return;
  S.apifyKey = k; localStorage.setItem('hp_apify',k);
  document.getElementById('s-key').value = k;
  updateKeyDisplay(); ckm();
  try {
    const r = await fetch(`https://api.apify.com/v2/users/me?token=${k}`);
    const d = await r.json();
    if (d.data?.username) log(`âœ“ Apify key valid â€” user: ${d.data.username}`, 'lok');
    else log('âš  Key may be invalid â€” double-check it', 'lw');
  } catch(e) { log('Key test failed: '+e.message, 'lw'); }
}
function saveKey() {
  const k = document.getElementById('s-key').value.trim();
  if (!k) return;
  S.apifyKey = k; localStorage.setItem('hp_apify',k);
  updateKeyDisplay(); alert('API key saved!');
}
function updateKeyDisplay() {
  const k = S.apifyKey;
  document.getElementById('key-disp').textContent = k ? k.substring(0,16)+'...'+k.slice(-4) : 'Not set â€” click to add';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function otm() { document.getElementById('tm').classList.add('on'); }
function ctm() { document.getElementById('tm').classList.remove('on'); }
function confirmTab() {
  const n = document.getElementById('m-tab').value.trim();
  if (n) { document.getElementById('ctab').value = n; }
  ctm(); document.getElementById('m-tab').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg, cls='li') {
  const b = document.getElementById('logbox');
  b.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  b.scrollTop = b.scrollHeight;
}
function clearLog() { document.getElementById('logbox').innerHTML=''; }
function prog(pct, lbl) {
  document.getElementById('pw').style.display = 'block';
  document.getElementById('pf').style.width = pct+'%';
  document.getElementById('plbl').textContent = lbl;
  document.getElementById('ppct').textContent = pct+'%';
  const b = document.getElementById('run-badge');
  b.textContent = 'â³ '+lbl; b.classList.add('on');
}
function setRunning(on) {
  const b = document.getElementById('btn-run');
  b.disabled = on;
  b.innerHTML = on ? '<div class="spin"></div><span>Running...</span>' : '<span>â–¶ Start Scraping</span>';
  if (!on) document.getElementById('run-badge').classList.remove('on');
}
function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot() {
  // Check if Google just redirected back with a token
  if (checkAuthRedirect()) {
    await initApp();
    return;
  }
  // Check if we have a saved session token
  const saved = sessionStorage.getItem('hp_token');
  if (saved) {
    S.token = saved;
    await initApp();
    return;
  }
  // Show auth screen
  document.getElementById('auth-screen').style.display = 'flex';
  renderActors();
  if (S.apifyKey) updateKeyDisplay();
})();
</script>
</body>
</html>
