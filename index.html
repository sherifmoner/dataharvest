<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harvest Pro ‚Äî Apify Control Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07070f;
  --s1: #0d0d1a;
  --s2: #131320;
  --border: #1c1c30;
  --border2: #252540;
  --accent: #ff6b2b;
  --accent2: #ffaa00;
  --blue: #4f8ef7;
  --green: #22c55e;
  --red: #ef4444;
  --text: #e2e2f0;
  --muted: #55556e;
  --muted2: #8888a8;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; }
#auth-screen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(255,107,43,0.07) 0%, transparent 70%);
}
.auth-box { max-width: 460px; width: 100%; padding: 24px; text-align: center; }
.auth-icon { font-size: 3.5rem; margin-bottom: 20px; display: block; animation: float 3s ease-in-out infinite; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
.auth-box h1 { font-family:'Bebas Neue',sans-serif; font-size:3.2rem; letter-spacing:.05em; margin-bottom:8px; }
.auth-box h1 em { color:var(--accent); font-style:normal; }
.auth-box p { color:var(--muted2); font-size:.9rem; line-height:1.6; margin-bottom:32px; }
.features { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:32px; text-align:left; }
.feat { background:var(--s1); border:1px solid var(--border); border-radius:10px; padding:14px; }
.feat .fi { font-size:1.3rem; margin-bottom:6px; }
.feat strong { display:block; font-size:.85rem; margin-bottom:2px; }
.feat span { color:var(--muted); font-size:.75rem; }
.btn-google {
  width:100%; padding:15px; background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:12px; font-family:'Outfit',sans-serif; font-weight:700; font-size:1rem;
  color:#000; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all .2s;
}
.btn-google:hover { transform:translateY(-2px); box-shadow:0 12px 32px rgba(255,107,43,.35); }
.btn-google svg { width:22px; height:22px; }
#app-screen { height:100vh; flex-direction:column; display:none; }
.topbar {
  height:56px; background:var(--s1); border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 20px; gap:16px; flex-shrink:0;
}
.logo { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:.05em; }
.logo em { color:var(--accent); font-style:normal; }
.topbar-sep { flex:1; }
.user-chip {
  display:flex; align-items:center; gap:8px; padding:5px 12px 5px 5px;
  background:var(--s2); border:1px solid var(--border); border-radius:20px; font-size:.8rem; cursor:pointer; transition:all .2s;
}
.user-chip:hover { border-color:var(--red); color:var(--red); }
.avatar { width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.75rem; color:#000; }
.content { display:flex; flex:1; overflow:hidden; }
.sidebar {
  width:240px; min-width:240px; background:var(--s1); border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow-y:auto;
}
.sidebar-section { padding:16px 12px 6px; font-size:.62rem; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); font-family:'JetBrains Mono',monospace; }
.nav-item {
  display:flex; align-items:center; gap:10px; padding:10px 12px; margin:2px 8px;
  border-radius:8px; cursor:pointer; font-size:.88rem; color:var(--muted2); transition:all .15s; border:1px solid transparent;
}
.nav-item:hover { background:var(--s2); color:var(--text); }
.nav-item.active { background:rgba(255,107,43,.1); color:var(--accent); border-color:rgba(255,107,43,.2); }
.nav-item .ni { width:20px; text-align:center; }
.api-panel { margin:8px; border:1px solid var(--border); border-radius:10px; padding:14px; background:var(--s2); }
.api-panel .ap-label { font-size:.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:8px; font-family:'JetBrains Mono',monospace; }
.api-val { font-family:'JetBrains Mono',monospace; font-size:.72rem; color:var(--accent2); word-break:break-all; cursor:pointer; line-height:1.4; }
.api-val:hover { color:var(--accent); }
.btn-change-api {
  margin-top:8px; width:100%; padding:6px; background:transparent; border:1px solid var(--border2);
  border-radius:6px; color:var(--muted2); font-family:'Outfit',sans-serif; font-size:.75rem; cursor:pointer; transition:all .2s;
}
.btn-change-api:hover { border-color:var(--accent); color:var(--accent); }
.quota-bar { margin-top:10px; }
.quota-label { display:flex; justify-content:space-between; font-size:.68rem; color:var(--muted); margin-bottom:4px; }
.bar-track { height:4px; background:var(--border); border-radius:2px; }
.bar-fill { height:4px; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:2px; transition:width .5s; }
.panel-area { flex:1; overflow-y:auto; padding:24px; }
.page { display:none; }
.page.active { display:block; }
.page-title { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:.05em; margin-bottom:4px; }
.page-sub { color:var(--muted2); font-size:.85rem; margin-bottom:24px; }
.actor-search-row { display:flex; gap:10px; margin-bottom:20px; }
.search-wrap { flex:1; position:relative; }
.search-wrap input {
  width:100%; padding:11px 14px 11px 38px; background:var(--s1);
  border:1px solid var(--border); border-radius:10px; color:var(--text);
  font-family:'Outfit',sans-serif; font-size:.9rem; outline:none; transition:border-color .2s;
}
.search-wrap input:focus { border-color:var(--accent); }
.search-wrap .si { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); }
.btn-refresh { padding:11px 16px; background:var(--s1); border:1px solid var(--border); border-radius:10px; color:var(--muted2); cursor:pointer; font-size:.85rem; transition:all .2s; font-family:'Outfit',sans-serif; }
.btn-refresh:hover { border-color:var(--blue); color:var(--blue); }
.category-pills { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; }
.pill { padding:6px 14px; background:var(--s1); border:1px solid var(--border); border-radius:20px; font-size:.78rem; color:var(--muted2); cursor:pointer; transition:all .2s; white-space:nowrap; }
.pill:hover { border-color:var(--accent); color:var(--accent); }
.pill.active { background:rgba(255,107,43,.12); border-color:var(--accent); color:var(--accent); }
.actor-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:14px; }
.actor-card { background:var(--s1); border:1px solid var(--border); border-radius:12px; padding:16px; cursor:pointer; transition:all .2s; position:relative; }
.actor-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.4); }
.actor-card.selected { border-color:var(--accent); background:rgba(255,107,43,.06); }
.ac-icon { font-size:1.8rem; margin-bottom:10px; }
.ac-name { font-weight:600; font-size:.92rem; margin-bottom:4px; }
.ac-id { font-family:'JetBrains Mono',monospace; font-size:.65rem; color:var(--muted); margin-bottom:8px; }
.ac-desc { font-size:.78rem; color:var(--muted2); line-height:1.5; }
.ac-tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:10px; }
.ac-tag { padding:2px 8px; background:var(--s2); border:1px solid var(--border2); border-radius:4px; font-size:.65rem; color:var(--muted2); }
.ac-badge { position:absolute; top:12px; right:12px; padding:3px 8px; border-radius:4px; font-size:.65rem; font-weight:700; }
.ac-badge.pop { background:rgba(255,107,43,.15); color:var(--accent); border:1px solid rgba(255,107,43,.3); }
.run-layout { display:grid; grid-template-columns:1fr 380px; gap:20px; }
.run-card { background:var(--s1); border:1px solid var(--border); border-radius:14px; padding:22px; }
.run-card h3 { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:.05em; color:var(--accent); margin-bottom:18px; }
.form-group { margin-bottom:16px; }
label { display:block; font-size:.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; margin-bottom:6px; font-family:'JetBrains Mono',monospace; }
input[type=text], input[type=url], input[type=number], select, textarea {
  width:100%; padding:11px 13px; background:var(--bg); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:'Outfit',sans-serif; font-size:.88rem; outline:none; transition:border-color .2s;
}
input:focus, select:focus, textarea:focus { border-color:var(--accent); }
select option { background:var(--s1); }
textarea { resize:vertical; min-height:80px; }
.hint { font-size:.72rem; color:var(--muted); margin-top:4px; font-family:'JetBrains Mono',monospace; }
.selected-actor-banner { display:flex; align-items:center; gap:14px; padding:16px; background:rgba(255,107,43,.06); border:1px solid rgba(255,107,43,.2); border-radius:10px; margin-bottom:20px; }
.sab-icon { font-size:2rem; }
.sab-name { font-weight:700; font-size:1rem; }
.sab-id { font-family:'JetBrains Mono',monospace; font-size:.7rem; color:var(--muted); margin-top:2px; }
.sab-change { margin-left:auto; padding:6px 12px; background:transparent; border:1px solid var(--border2); border-radius:6px; color:var(--muted2); font-family:'Outfit',sans-serif; font-size:.75rem; cursor:pointer; transition:all .2s; }
.sab-change:hover { border-color:var(--accent); color:var(--accent); }
.sheets-row { display:flex; gap:8px; align-items:flex-end; }
.sheets-row select { flex:1; }
.btn-new-sheet { padding:11px 13px; background:transparent; border:1px solid var(--border); border-radius:8px; color:var(--muted2); cursor:pointer; font-size:.85rem; transition:all .2s; white-space:nowrap; font-family:'Outfit',sans-serif; }
.btn-new-sheet:hover { border-color:var(--green); color:var(--green); }
.btn-refresh-sheets { padding:11px; background:transparent; border:1px solid var(--border); border-radius:8px; color:var(--muted2); cursor:pointer; font-size:.85rem; transition:all .2s; }
.btn-refresh-sheets:hover { border-color:var(--blue); color:var(--blue); }
.btn-run {
  width:100%; padding:16px; background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none; border-radius:10px; color:#000; font-family:'Outfit',sans-serif; font-weight:700; font-size:1.05rem;
  cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all .2s; margin-top:8px;
}
.btn-run:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 8px 24px rgba(255,107,43,.35); }
.btn-run:disabled { opacity:.5; cursor:not-allowed; }
.log-box { height:220px; overflow-y:auto; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:12px; font-family:'JetBrains Mono',monospace; font-size:.72rem; line-height:1.8; }
.l-info { color:var(--muted2); }
.l-ok { color:var(--green); }
.l-err { color:var(--red); }
.l-warn { color:var(--accent2); }
.l-accent { color:var(--accent); }
.progress-wrap { margin-top:14px; }
.prog-label { display:flex; justify-content:space-between; font-size:.72rem; color:var(--muted); margin-bottom:6px; font-family:'JetBrains Mono',monospace; }
.prog-track { height:6px; background:var(--border); border-radius:3px; }
.prog-fill { height:6px; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:3px; width:0%; transition:width .4s; }
.results-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.res-count { padding:4px 12px; background:rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.25); border-radius:20px; font-size:.75rem; color:var(--green); }
.btn-csv { padding:8px 14px; background:transparent; border:1px solid var(--border2); border-radius:7px; color:var(--muted2); font-family:'Outfit',sans-serif; font-size:.78rem; cursor:pointer; transition:all .2s; }
.btn-csv:hover { border-color:var(--green); color:var(--green); }
.table-wrap { overflow-x:auto; max-height:360px; overflow-y:auto; }
table { width:100%; border-collapse:collapse; font-size:.78rem; }
th { padding:9px 12px; background:var(--bg); border-bottom:1px solid var(--border); color:var(--muted); font-size:.68rem; text-transform:uppercase; letter-spacing:.06em; font-weight:400; font-family:'JetBrains Mono',monospace; text-align:left; position:sticky; top:0; white-space:nowrap; }
td { padding:9px 12px; border-bottom:1px solid var(--border); color:var(--text); max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
tr:hover td { background:rgba(255,255,255,.02); }
td a { color:var(--blue); text-decoration:none; }
td a:hover { text-decoration:underline; }
.sheet-open-btn { display:inline-flex; align-items:center; gap:8px; margin-top:14px; padding:10px 18px; background:rgba(79,142,247,.08); border:1px solid rgba(79,142,247,.25); border-radius:8px; color:var(--blue); text-decoration:none; font-size:.85rem; transition:all .2s; }
.sheet-open-btn:hover { background:rgba(79,142,247,.15); }
.history-item { display:flex; align-items:center; gap:16px; padding:16px; background:var(--s1); border:1px solid var(--border); border-radius:12px; margin-bottom:10px; transition:border-color .2s; cursor:pointer; }
.history-item:hover { border-color:var(--border2); }
.hi-name { font-weight:600; font-size:.9rem; margin-bottom:2px; }
.hi-meta { font-size:.75rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }
.hi-rows { margin-left:auto; padding:4px 12px; background:var(--s2); border:1px solid var(--border2); border-radius:20px; font-size:.75rem; color:var(--muted2); }
.hi-status { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.hi-status.ok { background:var(--green); }
.hi-status.err { background:var(--red); }
.settings-card { background:var(--s1); border:1px solid var(--border); border-radius:14px; padding:24px; margin-bottom:16px; }
.settings-card h3 { font-weight:600; font-size:1rem; margin-bottom:18px; padding-bottom:12px; border-bottom:1px solid var(--border); }
.setting-row { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border); }
.setting-row:last-child { border-bottom:none; }
.sr-label { font-size:.88rem; }
.sr-sub { font-size:.75rem; color:var(--muted); margin-top:2px; }
.toggle { width:44px; height:24px; background:var(--border2); border-radius:12px; position:relative; cursor:pointer; transition:background .2s; flex-shrink:0; }
.toggle.on { background:var(--green); }
.toggle::after { content:''; position:absolute; width:18px; height:18px; background:#fff; border-radius:50%; top:3px; left:3px; transition:left .2s; }
.toggle.on::after { left:23px; }
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:100; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal-overlay.show { display:flex; }
.modal { background:var(--s1); border:1px solid var(--border2); border-radius:16px; padding:28px; width:100%; max-width:480px; margin:20px; }
.modal h3 { font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:.05em; margin-bottom:18px; }
.modal-btns { display:flex; gap:10px; margin-top:20px; }
.btn-cancel { flex:1; padding:11px; background:transparent; border:1px solid var(--border2); border-radius:8px; color:var(--muted2); cursor:pointer; font-family:'Outfit',sans-serif; transition:all .2s; }
.btn-cancel:hover { border-color:var(--red); color:var(--red); }
.btn-save { flex:1; padding:11px; background:var(--accent); border:none; border-radius:8px; color:#000; font-family:'Outfit',sans-serif; font-weight:700; cursor:pointer; transition:all .2s; }
.btn-save:hover { background:var(--accent2); }
.spin { width:18px; height:18px; border:2px solid rgba(0,0,0,.25); border-top-color:#000; border-radius:50%; animation:sp .5s linear infinite; }
@keyframes sp { to { transform:rotate(360deg); } }
.empty { text-align:center; padding:60px 20px; color:var(--muted); }
.empty .ei { font-size:3rem; margin-bottom:16px; }
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-box">
    <span class="auth-icon">‚ö°</span>
    <h1>Harvest <em>Pro</em></h1>
    <p>Full Apify control center. Browse any actor, configure leads by city & niche, and auto-save to any Google Sheet.</p>
    <div class="features">
      <div class="feat"><div class="fi">üó∫Ô∏è</div><strong>Any Apify Actor</strong><span>Google Maps, Search, Social & more</span></div>
      <div class="feat"><div class="fi">üìä</div><strong>Google Sheets</strong><span>Choose any sheet or tab from dropdown</span></div>
      <div class="feat"><div class="fi">üîë</div><strong>Key Manager</strong><span>Swap Apify API keys anytime</span></div>
      <div class="feat"><div class="fi">üìÇ</div><strong>Run History</strong><span>Track all your scraping jobs</span></div>
    </div>
    <button class="btn-google" onclick="startAuth()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Connect with Google
    </button>
  </div>
</div>

<!-- APP -->
<div id="app-screen" style="display:none;">
  <div class="topbar">
    <div class="logo">Harvest <em>Pro</em></div>
    <div class="topbar-sep"></div>
    <div id="run-status" style="font-size:.78rem;color:var(--muted);font-family:'JetBrains Mono',monospace;"></div>
    <div class="user-chip" onclick="signOut()">
      <div class="avatar" id="user-avatar">?</div>
      <span id="user-email">...</span>
      <span style="color:var(--muted);margin-left:4px">‚úï</span>
    </div>
  </div>
  <div class="content">
    <div class="sidebar">
      <div class="sidebar-section">Navigation</div>
      <div class="nav-item active" onclick="nav('actors',this)"><span class="ni">üîç</span> Actor Browser</div>
      <div class="nav-item" onclick="nav('run',this)"><span class="ni">‚ñ∂Ô∏è</span> Run & Configure</div>
      <div class="nav-item" onclick="nav('history',this)"><span class="ni">üìÇ</span> Run History</div>
      <div class="nav-item" onclick="nav('settings',this)"><span class="ni">‚öôÔ∏è</span> Settings</div>
      <div style="margin-top:auto;">
        <div class="sidebar-section">Apify API Key</div>
        <div class="api-panel">
          <div class="ap-label">Active Key</div>
          <div class="api-val" id="api-key-display" onclick="openApiModal()">Click to set...</div>
          <button class="btn-change-api" onclick="openApiModal()">üîë Change API Key</button>
          <div class="quota-bar" id="quota-wrap" style="display:none">
            <div class="quota-label"><span>Usage</span><span id="quota-pct">0%</span></div>
            <div class="bar-track"><div class="bar-fill" id="quota-bar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-area">

      <!-- ACTOR BROWSER -->
      <div id="page-actors" class="page active">
        <div class="page-title">Actor Browser</div>
        <div class="page-sub">Search and select any Apify actor. Click an actor to configure and run it.</div>
        <div class="actor-search-row">
          <div class="search-wrap">
            <span class="si">üîç</span>
            <input type="text" id="actor-search" placeholder="Search: google maps, instagram, amazon..." oninput="filterActors()">
          </div>
          <button class="btn-refresh" onclick="searchApifyStore()">üîÑ Search Apify Store</button>
        </div>
        <div class="category-pills">
          <div class="pill active" onclick="filterCat('all',this)">All</div>
          <div class="pill" onclick="filterCat('maps',this)">üó∫ Maps & Places</div>
          <div class="pill" onclick="filterCat('search',this)">üîç Search Engines</div>
          <div class="pill" onclick="filterCat('social',this)">üì± Social Media</div>
          <div class="pill" onclick="filterCat('ecommerce',this)">üõç E-Commerce</div>
          <div class="pill" onclick="filterCat('leads',this)">üë• Leads</div>
          <div class="pill" onclick="filterCat('web',this)">üåê Web Scraping</div>
        </div>
        <div class="actor-grid" id="actor-grid"></div>
      </div>

      <!-- RUN -->
      <div id="page-run" class="page">
        <div class="page-title">Run & Configure</div>
        <div class="page-sub">Set up your scraping job and save results directly to Google Sheets.</div>
        <div id="no-actor-msg" class="empty"><div class="ei">üëÜ</div><p>Select an actor from the <strong>Actor Browser</strong> first.</p></div>
        <div id="run-content" style="display:none">
          <div class="selected-actor-banner">
            <div class="sab-icon" id="sab-icon">‚öôÔ∏è</div>
            <div><div class="sab-name" id="sab-name">-</div><div class="sab-id" id="sab-id">-</div></div>
            <button class="sab-change" onclick="nav('actors',document.querySelector('.nav-item'))">‚Üê Change Actor</button>
          </div>
          <div class="run-layout">
            <div>
              <div class="run-card">
                <h3>‚öô Actor Configuration</h3>
                <div id="dynamic-form"></div>
                <details style="margin-top:16px;">
                  <summary style="cursor:pointer;font-size:.8rem;color:var(--muted2);user-select:none;">‚ñ∏ Advanced: Custom JSON Input</summary>
                  <div style="margin-top:10px;">
                    <label>Raw Input JSON (overrides form above)</label>
                    <textarea id="custom-json" placeholder='{"queries": "coffee shops in Cairo", "maxResults": 50}'></textarea>
                    <div class="hint">Leave empty to use the form fields above</div>
                  </div>
                </details>
              </div>
              <div class="run-card" id="results-card" style="display:none;margin-top:16px;">
                <div class="results-header">
                  <h3 style="margin:0">üìä Results</h3>
                  <div style="display:flex;gap:8px;align-items:center">
                    <span class="res-count" id="res-count">0 rows</span>
                    <button class="btn-csv" onclick="downloadCSV()">‚¨á CSV</button>
                  </div>
                </div>
                <div class="table-wrap"><table><thead id="res-head"></thead><tbody id="res-body"></tbody></table></div>
                <a class="sheet-open-btn" id="sheet-open-btn" href="#" target="_blank">üìä Open in Google Sheets</a>
              </div>
            </div>
            <div>
              <div class="run-card" style="margin-bottom:16px;">
                <h3>üìä Save to Google Sheets</h3>
                <div class="form-group">
                  <label>Spreadsheet</label>
                  <div class="sheets-row">
                    <select id="sheet-select" onchange="loadTabs(this.value)"><option value="">Loading...</option></select>
                    <button class="btn-refresh-sheets" onclick="loadSheets()" title="Refresh">üîÑ</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Tab / Sheet</label>
                  <div class="sheets-row">
                    <select id="tab-select"><option>Select spreadsheet first</option></select>
                    <button class="btn-new-sheet" onclick="openTabModal()">+ New Tab</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Or type a new tab name</label>
                  <input type="text" id="custom-tab" placeholder="e.g. Cairo Coffee Leads June 2025">
                  <div class="hint">If filled, this overrides the tab dropdown</div>
                </div>
              </div>
              <div class="run-card">
                <h3>‚ñ∂ Execute</h3>
                <button class="btn-run" id="btn-run" onclick="runActor()"><span>‚ñ∂ Start Scraping</span></button>
                <div class="progress-wrap" id="prog-wrap" style="display:none">
                  <div class="prog-label"><span id="prog-label">Initializing...</span><span id="prog-pct">0%</span></div>
                  <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
                </div>
                <div style="margin-top:14px;">
                  <label>Live Log</label>
                  <div class="log-box" id="log-box"><div class="l-info">// Ready. Configure above and click Start Scraping.</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div id="page-history" class="page">
        <div class="page-title">Run History</div>
        <div class="page-sub">All scraping jobs from this session.</div>
        <div id="history-list"><div class="empty"><div class="ei">üìÇ</div><p>No runs yet.</p></div></div>
      </div>

      <!-- SETTINGS -->
      <div id="page-settings" class="page">
        <div class="page-title">Settings</div>
        <div class="page-sub">Manage your API keys, sheet preferences, and run options.</div>
        <div class="settings-card">
          <h3>üîë Apify API Key</h3>
          <div class="form-group">
            <label>API Key</label>
            <input type="text" id="settings-apify-key" placeholder="apify_api_...">
            <div class="hint">Get yours at console.apify.com ‚Üí Settings ‚Üí Integrations</div>
          </div>
          <button class="btn-run" style="max-width:180px;" onclick="saveApifyKey()">Save Key</button>
        </div>
        <div class="settings-card">
          <h3>üìä Add Extra Google Sheet</h3>
          <div class="form-group">
            <label>Sheet ID (from URL)</label>
            <input type="text" id="settings-sheet-id" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
            <div class="hint">From: docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</div>
          </div>
          <button class="btn-run" style="max-width:200px;" onclick="addSheetById()">Add Sheet</button>
        </div>
        <div class="settings-card">
          <h3>‚öô Run Preferences</h3>
          <div class="setting-row">
            <div><div class="sr-label">Auto-open sheet after run</div><div class="sr-sub">Opens Google Sheets when scraping completes</div></div>
            <div class="toggle" id="tog-autoopen" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="setting-row">
            <div><div class="sr-label">Append mode (add rows)</div><div class="sr-sub">Adds below existing data instead of overwriting</div></div>
            <div class="toggle on" id="tog-append" onclick="this.classList.toggle('on')"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="api-modal">
  <div class="modal">
    <h3>üîë Change Apify API Key</h3>
    <div class="form-group">
      <label>Apify API Key</label>
      <input type="text" id="modal-api-key" placeholder="apify_api_...">
      <div class="hint">Find it at: console.apify.com ‚Üí Settings ‚Üí Integrations</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeApiModal()">Cancel</button>
      <button class="btn-save" onclick="saveApiKeyFromModal()">Save & Test</button>
    </div>
  </div>
</div>

<!-- NEW TAB MODAL -->
<div class="modal-overlay" id="tab-modal">
  <div class="modal">
    <h3>‚ûï New Sheet Tab</h3>
    <div class="form-group">
      <label>Tab Name</label>
      <input type="text" id="new-tab-name" placeholder="e.g. Cairo Restaurants July 2025">
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeTabModal()">Cancel</button>
      <button class="btn-save" onclick="confirmNewTab()">Use This Name</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const STATE = {
  token: null,
  apifyKey: localStorage.getItem('apify_key') || '',
  selectedActor: null,
  results: [], headers: [],
  history: [],
  sheets: [],
  currentCategory: 'all',
  extraSheetIds: JSON.parse(localStorage.getItem('extra_sheets') || '[]')
};

const CLIENT_ID = '633930604616-oda4vnsest0uhg8ivci8uv2j3g7iovh7.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
const REDIRECT = window.location.href.split('?')[0].split('#')[0];

// ‚ïê‚ïê‚ïê ACTOR CATALOG ‚ïê‚ïê‚ïê
const ACTORS = [
  { id:'compass/crawler-google-places', name:'Google Maps Scraper', icon:'üó∫Ô∏è', cat:'maps', desc:'Extract businesses from Google Maps by keyword, city, and category. Returns name, address, phone, website, rating, reviews.', tags:['maps','leads','local'], badge:'pop',
    form:[
      {key:'searchStringsArray',label:'What to Search (one per line)',type:'textarea',placeholder:'coffee shops\nrestaurants\ngyms',hint:'City will be automatically appended below'},
      {key:'city',label:'City / Location',type:'text',placeholder:'Cairo, Egypt'},
      {key:'maxCrawledPlacesPerSearch',label:'Max Results Per Search',type:'number',default:50},
      {key:'language',label:'Language',type:'select',options:['en','ar','fr','de','es'],default:'en'},
    ]},
  { id:'drobnikj/google-maps-scraper', name:'Google Maps + Email Finder', icon:'üìß', cat:'maps', desc:'Find emails and contact details from Google Maps listings.', tags:['maps','email','leads'],
    form:[
      {key:'queries',label:'Search Queries (one per line)',type:'textarea',placeholder:'dentists in Cairo\ngyms in Alexandria'},
      {key:'maxResults',label:'Max Leads',type:'number',default:50},
    ]},
  { id:'apify/google-search-scraper', name:'Google Search Scraper', icon:'üîç', cat:'search', desc:'Scrape Google search results for any keyword. Great for SEO research and competitor analysis.', tags:['google','search','seo'], badge:'pop',
    form:[
      {key:'queries',label:'Search Queries (one per line)',type:'textarea',placeholder:'best restaurants in Cairo\nmarketing agencies Egypt'},
      {key:'maxPagesPerQuery',label:'Pages Per Query',type:'number',default:1},
      {key:'resultsPerPage',label:'Results Per Page',type:'select',options:['10','20','50','100'],default:'10'},
      {key:'countryCode',label:'Country',type:'select',options:['eg','us','gb','ae','sa','fr','de','tr'],default:'eg'},
      {key:'languageCode',label:'Language',type:'select',options:['en','ar','fr','de'],default:'en'},
    ]},
  { id:'apify/instagram-scraper', name:'Instagram Scraper', icon:'üì∏', cat:'social', desc:'Scrape Instagram profiles, posts, hashtags and comments.', tags:['instagram','social','influencer'],
    form:[
      {key:'directUrls',label:'Instagram URLs (one per line)',type:'textarea',placeholder:'https://www.instagram.com/username/\nhttps://www.instagram.com/explore/tags/cairo/'},
      {key:'resultsLimit',label:'Max Posts / Profiles',type:'number',default:50},
    ]},
  { id:'apify/twitter-scraper', name:'Twitter / X Scraper', icon:'üê¶', cat:'social', desc:'Scrape tweets, profiles, trends and hashtag data.', tags:['twitter','x','social'],
    form:[
      {key:'searchTerms',label:'Search Terms / Hashtags (one per line)',type:'textarea',placeholder:'#cairo\nEgypt startups'},
      {key:'maxTweets',label:'Max Tweets',type:'number',default:100},
      {key:'startDate',label:'Start Date (optional)',type:'text',placeholder:'2024-01-01'},
    ]},
  { id:'apify/linkedin-scraper', name:'LinkedIn Company Scraper', icon:'üíº', cat:'social', desc:'Scrape LinkedIn company pages for B2B leads and business info.', tags:['linkedin','b2b','leads'],
    form:[
      {key:'startUrls',label:'LinkedIn Company URLs (one per line)',type:'textarea',placeholder:'https://www.linkedin.com/company/apple/'},
      {key:'maxResults',label:'Max Results',type:'number',default:20},
    ]},
  { id:'apify/facebook-pages-scraper', name:'Facebook Pages Scraper', icon:'üë•', cat:'social', desc:'Scrape Facebook page info and posts.', tags:['facebook','social'],
    form:[
      {key:'startUrls',label:'Facebook Page URLs (one per line)',type:'textarea',placeholder:'https://www.facebook.com/pagename'},
      {key:'maxPosts',label:'Max Posts',type:'number',default:20},
    ]},
  { id:'apify/amazon-product-scraper', name:'Amazon Product Scraper', icon:'üì¶', cat:'ecommerce', desc:'Scrape Amazon product listings, prices, reviews and rankings.', tags:['amazon','products','ecommerce'], badge:'pop',
    form:[
      {key:'keywords',label:'Search Keywords',type:'text',placeholder:'wireless earbuds'},
      {key:'maxItems',label:'Max Products',type:'number',default:50},
      {key:'country',label:'Amazon Site',type:'select',options:['US','UK','DE','FR','AE','SA'],default:'US'},
    ]},
  { id:'apify/booking-scraper', name:'Booking.com Scraper', icon:'üè®', cat:'ecommerce', desc:'Scrape hotel listings, prices and reviews from Booking.com.', tags:['hotels','travel','prices'],
    form:[
      {key:'search',label:'Destination',type:'text',placeholder:'Cairo, Egypt'},
      {key:'checkIn',label:'Check-in Date',type:'text',placeholder:'2025-08-01'},
      {key:'checkOut',label:'Check-out Date',type:'text',placeholder:'2025-08-05'},
      {key:'maxResults',label:'Max Hotels',type:'number',default:30},
    ]},
  { id:'apify/yelp-scraper', name:'Yelp Business Scraper', icon:'‚≠ê', cat:'leads', desc:'Scrape Yelp for local business info, ratings and contact details.', tags:['yelp','leads','reviews'],
    form:[
      {key:'searchTerms',label:'Business Type / Niche',type:'text',placeholder:'restaurants'},
      {key:'location',label:'City / Location',type:'text',placeholder:'Cairo'},
      {key:'maxItems',label:'Max Leads',type:'number',default:50},
    ]},
  { id:'apify/yellow-pages-scraper', name:'Yellow Pages Scraper', icon:'üìí', cat:'leads', desc:'Scrape Yellow Pages business listings with contact info.', tags:['yellowpages','leads','contacts'],
    form:[
      {key:'search',label:'Business Type',type:'text',placeholder:'plumbers'},
      {key:'location',label:'Location',type:'text',placeholder:'Cairo, Egypt'},
      {key:'maxItems',label:'Max Results',type:'number',default:50},
    ]},
  { id:'apify/web-scraper', name:'Universal Web Scraper', icon:'üåê', cat:'web', desc:'Crawl any website and extract text, links, and custom data.', tags:['web','crawler','general'],
    form:[
      {key:'startUrls',label:'Start URL(s) ‚Äî one per line',type:'textarea',placeholder:'https://example.com'},
      {key:'maxCrawlPages',label:'Max Pages',type:'number',default:10},
      {key:'maxCrawlDepth',label:'Crawl Depth',type:'number',default:2},
    ]},
  { id:'apify/cheerio-scraper', name:'Fast HTML Scraper', icon:'‚ö°', cat:'web', desc:'High-speed scraper using CSS selectors ‚Äî great for structured pages.', tags:['html','fast','css'],
    form:[
      {key:'startUrls',label:'Start URL',type:'text',placeholder:'https://example.com'},
      {key:'maxRequestsPerCrawl',label:'Max Requests',type:'number',default:100},
      {key:'selector',label:'CSS Selector (optional)',type:'text',placeholder:'.article-title, .price'},
    ]},
];

let filteredActors = [...ACTORS];

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function startAuth() {
  const p = new URLSearchParams({ client_id:CLIENT_ID, redirect_uri:REDIRECT, response_type:'token', scope:SCOPES, prompt:'consent' });
  const popup = window.open(`https://accounts.google.com/o/oauth2/v2/auth?${p}`, 'auth', 'width=500,height=600,left=300,top=100');
  const poll = setInterval(() => {
    try {
      if (popup.closed) { clearInterval(poll); return; }
      const url = popup.location.href;
      if (url.includes('access_token')) {
        clearInterval(poll); popup.close();
        handleToken(new URLSearchParams(url.split('#')[1]).get('access_token'));
      }
    } catch(e) {}
  }, 500);
}

window.addEventListener('load', () => {
  const h = window.location.hash;
  if (h.includes('access_token')) {
    const token = new URLSearchParams(h.substring(1)).get('access_token');
    history.replaceState({}, '', window.location.pathname);
    handleToken(token);
  }
  if (STATE.apifyKey) { updateApiDisplay(); document.getElementById('settings-apify-key').value = STATE.apifyKey; }
  renderActors();
});

async function handleToken(token) {
  STATE.token = token;
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: `Bearer ${token}` } });
    const u = await r.json();
    document.getElementById('user-email').textContent = u.email;
    document.getElementById('user-avatar').textContent = (u.name || u.email || '?')[0].toUpperCase();
  } catch(e) {}
  document.getElementById('auth-screen').style.display = 'none';
  const app = document.getElementById('app-screen');
  app.style.display = 'flex';
  app.style.flexDirection = 'column';
  loadSheets();
  if (STATE.apifyKey) testApifyKey();
}

function signOut() {
  STATE.token = null;
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app-screen').style.display = 'none';
}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
function nav(page, el) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  // find correct nav item if not passed
  if (!el) {
    document.querySelectorAll('.nav-item').forEach(n => {
      if (n.textContent.toLowerCase().includes(page)) n.classList.add('active');
    });
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
}

// ‚ïê‚ïê‚ïê ACTORS ‚ïê‚ïê‚ïê
function renderActors() {
  const grid = document.getElementById('actor-grid');
  if (!filteredActors.length) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1"><div class="ei">üîç</div><p>No actors found.</p></div>';
    return;
  }
  grid.innerHTML = filteredActors.map(a => `
    <div class="actor-card${STATE.selectedActor?.id===a.id?' selected':''}" onclick="selectActor('${a.id}')">
      ${a.badge?`<span class="ac-badge pop">‚≠ê Popular</span>`:''}
      <div class="ac-icon">${a.icon}</div>
      <div class="ac-name">${a.name}</div>
      <div class="ac-id">${a.id}</div>
      <div class="ac-desc">${a.desc}</div>
      <div class="ac-tags">${a.tags.map(t=>`<span class="ac-tag">${t}</span>`).join('')}</div>
    </div>
  `).join('');
}

function filterActors() {
  const q = document.getElementById('actor-search').value.toLowerCase();
  filteredActors = ACTORS.filter(a =>
    (!q || a.name.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q) || a.tags.some(t=>t.includes(q)) || a.id.includes(q)) &&
    (STATE.currentCategory === 'all' || a.cat === STATE.currentCategory)
  );
  renderActors();
}

function filterCat(cat, el) {
  STATE.currentCategory = cat;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  filterActors();
}

async function searchApifyStore() {
  const q = document.getElementById('actor-search').value.trim();
  if (!STATE.apifyKey) { openApiModal(); return; }
  if (!q) { alert('Enter a search term first.'); return; }
  log('Searching Apify Store for: ' + q, 'l-info');
  try {
    const r = await fetch(`https://api.apify.com/v2/store?token=${STATE.apifyKey}&search=${encodeURIComponent(q)}&limit=20`);
    const data = await r.json();
    if (data.data?.items?.length) {
      const extra = data.data.items.map(a => ({
        id: `${a.username}/${a.name}`, name: a.title || a.name, icon: 'üîß', cat: 'web',
        desc: (a.description || 'No description.').substring(0,120),
        tags: [a.username],
        form: [{key:'_json',label:'Input JSON (see actor docs)',type:'textarea',placeholder:'{"key":"value"}'}]
      }));
      filteredActors = [...ACTORS.filter(a=>a.name.toLowerCase().includes(q.toLowerCase())), ...extra];
      renderActors();
      log(`Found ${extra.length} actors in Apify Store`, 'l-ok');
    } else { log('No store results found', 'l-warn'); }
  } catch(e) { log('Store search failed: ' + e.message, 'l-err'); }
}

function selectActor(id) {
  STATE.selectedActor = filteredActors.find(a => a.id === id) || ACTORS.find(a => a.id === id);
  renderActors();
  buildDynamicForm();
  // Switch to run tab
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.nav-item')[1].classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-run').classList.add('active');
}

// ‚ïê‚ïê‚ïê DYNAMIC FORM ‚ïê‚ïê‚ïê
function buildDynamicForm() {
  const a = STATE.selectedActor;
  if (!a) return;
  document.getElementById('no-actor-msg').style.display = 'none';
  document.getElementById('run-content').style.display = 'block';
  document.getElementById('sab-icon').textContent = a.icon;
  document.getElementById('sab-name').textContent = a.name;
  document.getElementById('sab-id').textContent = a.id;
  document.getElementById('custom-json').value = '';

  document.getElementById('dynamic-form').innerHTML = a.form.map(f => {
    if (f.type === 'text' || f.type === 'url' || f.type === 'number')
      return `<div class="form-group"><label>${f.label}</label><input type="${f.type}" id="f_${f.key}" placeholder="${f.placeholder||''}" value="${f.default||''}">${f.hint?`<div class="hint">${f.hint}</div>`:''}</div>`;
    if (f.type === 'textarea')
      return `<div class="form-group"><label>${f.label}</label><textarea id="f_${f.key}" placeholder="${f.placeholder||''}">${f.default||''}</textarea>${f.hint?`<div class="hint">${f.hint}</div>`:''}</div>`;
    if (f.type === 'select')
      return `<div class="form-group"><label>${f.label}</label><select id="f_${f.key}">${f.options.map(o=>`<option value="${o}"${o===f.default?' selected':''}>${o}</option>`).join('')}</select></div>`;
    if (f.type === 'checkbox')
      return `<div class="form-group" style="display:flex;align-items:center;gap:10px;"><input type="checkbox" id="f_${f.key}" style="width:auto" ${f.default?'checked':''}><label for="f_${f.key}" style="text-transform:none;letter-spacing:0;font-size:.88rem;color:var(--text);margin:0">${f.label}</label></div>`;
    return '';
  }).join('');
}

function collectInput() {
  const a = STATE.selectedActor;
  const cj = document.getElementById('custom-json').value.trim();
  if (cj) { try { return JSON.parse(cj); } catch(e) { throw new Error('Invalid JSON: ' + e.message); } }
  const inp = {};
  a.form.forEach(f => {
    const el = document.getElementById('f_' + f.key);
    if (!el) return;
    if (f.type === 'checkbox') { inp[f.key] = el.checked; return; }
    if (f.type === 'number') { const v = parseFloat(el.value); if (!isNaN(v)) inp[f.key] = v; return; }
    const val = el.value.trim();
    if (!val) return;
    if (f.type === 'textarea') {
      const lines = val.split('\n').map(l=>l.trim()).filter(Boolean);
      inp[f.key] = lines.length === 1 ? lines[0] : lines;
    } else { inp[f.key] = val; }
  });

  // Smart transforms
  const id = a.id;
  if (id.includes('crawler-google-places') || id.includes('google-places')) {
    const city = inp.city || '';
    if (inp.searchStringsArray) {
      const arr = Array.isArray(inp.searchStringsArray) ? inp.searchStringsArray : [inp.searchStringsArray];
      inp.searchStringsArray = city ? arr.map(q => q + ' in ' + city) : arr;
    }
    delete inp.city;
  }
  if ((id.includes('web-scraper') || id.includes('cheerio')) && inp.startUrls) {
    const urls = Array.isArray(inp.startUrls) ? inp.startUrls : [inp.startUrls];
    inp.startUrls = urls.map(u => ({ url: u }));
  }
  if (id.includes('google-search') && inp.queries && Array.isArray(inp.queries)) inp.queries = inp.queries.join('\n');
  return inp;
}

// ‚ïê‚ïê‚ïê SHEETS ‚ïê‚ïê‚ïê
async function loadSheets() {
  if (!STATE.token) return;
  const sel = document.getElementById('sheet-select');
  sel.innerHTML = '<option>Loading your sheets...</option>';
  try {
    const r = await fetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.spreadsheet'&fields=files(id,name)&pageSize=100&orderBy=modifiedTime+desc", {
      headers: { Authorization: `Bearer ${STATE.token}` }
    });
    const data = await r.json();
    STATE.sheets = data.files || [];

    // Add extra sheets not in Drive list
    STATE.extraSheetIds.forEach(id => {
      if (!STATE.sheets.find(s => s.id === id)) STATE.sheets.push({ id, name: `Sheet (${id.substring(0,8)}...)` });
    });

    sel.innerHTML = STATE.sheets.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    sel.onchange = () => loadTabs(sel.value);
    if (sel.value) loadTabs(sel.value);
  } catch(e) {
    sel.innerHTML = '<option>Could not load sheets</option>';
    log('Sheets load error: ' + e.message, 'l-err');
  }
}

async function loadTabs(sheetId) {
  if (!sheetId || !STATE.token) return;
  const tabSel = document.getElementById('tab-select');
  tabSel.innerHTML = '<option>Loading tabs...</option>';
  try {
    const r = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties`, { headers: { Authorization: `Bearer ${STATE.token}` } });
    const data = await r.json();
    const tabs = (data.sheets || []).map(s => s.properties.title);
    tabSel.innerHTML = tabs.map(t => `<option value="${t}">${t}</option>`).join('');
  } catch(e) { tabSel.innerHTML = '<option>Error loading tabs</option>'; }
}

function addSheetById() {
  const id = document.getElementById('settings-sheet-id').value.trim();
  if (!id) return;
  if (!STATE.extraSheetIds.includes(id)) {
    STATE.extraSheetIds.push(id);
    localStorage.setItem('extra_sheets', JSON.stringify(STATE.extraSheetIds));
  }
  loadSheets();
  alert('Sheet added! It will appear in the dropdown.');
}

async function saveToSheets(items, headers) {
  const sheetId = document.getElementById('sheet-select').value;
  if (!sheetId) throw new Error('No spreadsheet selected.');
  const customTab = document.getElementById('custom-tab').value.trim();
  const tabName = customTab || document.getElementById('tab-select').value || 'ScrapedData';
  const base = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`;
  const auth = { Authorization: `Bearer ${STATE.token}` };

  // Create tab if needed
  const metaR = await fetch(base, { headers: auth });
  const meta = await metaR.json();
  if (!(meta.sheets || []).find(s => s.properties.title === tabName)) {
    await fetch(`${base}:batchUpdate`, { method:'POST', headers:{...auth,'Content-Type':'application/json'}, body: JSON.stringify({ requests:[{addSheet:{properties:{title:tabName}}}] }) });
    log(`Created new tab: "${tabName}"`, 'l-ok');
    await loadTabs(sheetId);
  }

  const append = document.getElementById('tog-append').classList.contains('on');
  const rows = [headers, ...items.map(item => headers.map(h => String(item[h] ?? '')))];
  const range = `${tabName}!A1`;
  const url = append
    ? `${base}/values/${encodeURIComponent(range)}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`
    : `${base}/values/${encodeURIComponent(range)}?valueInputOption=RAW`;

  const res = await fetch(url, { method: append?'POST':'PUT', headers:{...auth,'Content-Type':'application/json'}, body: JSON.stringify({values:rows}) });
  if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || 'Sheets write failed'); }

  const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
  document.getElementById('sheet-open-btn').href = sheetUrl;
  if (document.getElementById('tog-autoopen').classList.contains('on')) window.open(sheetUrl, '_blank');
  return sheetUrl;
}

// ‚ïê‚ïê‚ïê RUN ‚ïê‚ïê‚ïê
async function runActor() {
  if (!STATE.apifyKey) { openApiModal(); return; }
  if (!STATE.selectedActor) { alert('Select an actor first.'); return; }
  if (!STATE.token) { alert('Please sign in first.'); return; }

  let input;
  try { input = collectInput(); } catch(e) { alert(e.message); return; }

  setRunning(true); clearLog();
  document.getElementById('results-card').style.display = 'none';
  setProgress(5, 'Starting...');

  log(`‚ñ∂ ${STATE.selectedActor.name}`, 'l-accent');
  log('Input: ' + JSON.stringify(input).substring(0,200), 'l-info');

  const actorId = STATE.selectedActor.id.replace('/', '~');
  try {
    const runRes = await fetch(`https://api.apify.com/v2/acts/${actorId}/runs?token=${STATE.apifyKey}`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(input)
    });
    if (!runRes.ok) { const e = await runRes.json(); throw new Error(e.error?.message || `HTTP ${runRes.status}`); }
    const run = await runRes.json();
    const runId = run.data.id;
    log('‚úì Run started ‚Äî ID: ' + runId, 'l-ok');
    setProgress(15, 'Job queued...');

    const items = await pollRun(runId);
    setProgress(85, 'Saving to Google Sheets...');
    if (!items.length) { log('‚ö† No results returned.', 'l-warn'); setRunning(false); return; }

    const headers = [...new Set(items.flatMap(i => Object.keys(i)))].slice(0, 40);
    STATE.results = items; STATE.headers = headers;
    log(`‚úì ${items.length} results scraped`, 'l-ok');

    const sheetUrl = await saveToSheets(items, headers);
    setProgress(100, 'Complete!');
    log(`‚úì Saved to Google Sheets`, 'l-ok');
    log(`‚Üí ${sheetUrl}`, 'l-ok');

    displayResults(items, headers);
    STATE.history.unshift({ actor:STATE.selectedActor.name, icon:STATE.selectedActor.icon, rows:items.length, time:new Date().toLocaleString(), status:'ok', sheetUrl });
  } catch(e) {
    log('‚úó ' + e.message, 'l-err');
    STATE.history.unshift({ actor:STATE.selectedActor.name, icon:STATE.selectedActor.icon, rows:0, time:new Date().toLocaleString(), status:'err' });
  }
  setRunning(false);
  renderHistory();
}

async function pollRun(runId) {
  const pcts = [20,30,40,50,60,70,75,80];
  for (let i = 0; i < 72; i++) {
    await sleep(5000);
    const r = await fetch(`https://api.apify.com/v2/actor-runs/${runId}?token=${STATE.apifyKey}`);
    const d = await r.json();
    const status = d.data?.status;
    setProgress(pcts[Math.min(i, pcts.length-1)], `${status} (${(i+1)*5}s)`);
    log(`[${(i+1)*5}s] ${status}`, 'l-info');
    if (status === 'SUCCEEDED') {
      const dsId = d.data.defaultDatasetId;
      const dr = await fetch(`https://api.apify.com/v2/datasets/${dsId}/items?token=${STATE.apifyKey}&format=json&limit=5000`);
      return await dr.json();
    }
    if (['FAILED','ABORTED','TIMED-OUT'].includes(status)) throw new Error('Run ' + status);
  }
  throw new Error('Timeout: run exceeded 6 minutes');
}

// ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê
function displayResults(items, headers) {
  document.getElementById('results-card').style.display = 'block';
  document.getElementById('res-count').textContent = items.length + ' rows';
  document.getElementById('res-head').innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
  document.getElementById('res-body').innerHTML = items.slice(0,100).map(item =>
    `<tr>${headers.map(h => {
      const v = String(item[h] ?? '');
      if ((h==='url'||h==='website'||h==='link')&&v.startsWith('http')) return `<td><a href="${v}" target="_blank">${v}</a></td>`;
      return `<td title="${v.replace(/"/g,'&quot;')}">${v}</td>`;
    }).join('')}</tr>`
  ).join('') + (items.length>100 ? `<tr><td colspan="${headers.length}" style="text-align:center;color:var(--muted);font-style:italic">...${items.length-100} more rows in Google Sheets</td></tr>` : '');
}

function downloadCSV() {
  if (!STATE.results.length) return;
  const rows = [STATE.headers, ...STATE.results.map(r => STATE.headers.map(h => `"${String(r[h]??'').replace(/"/g,'""')}"`))]
    .map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([rows],{type:'text/csv'}));
  a.download = (STATE.selectedActor?.name||'data').replace(/\s+/g,'-') + '-' + Date.now() + '.csv';
  a.click();
}

// ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê
function renderHistory() {
  const el = document.getElementById('history-list');
  if (!STATE.history.length) { el.innerHTML = '<div class="empty"><div class="ei">üìÇ</div><p>No runs yet.</p></div>'; return; }
  el.innerHTML = STATE.history.map(h => `
    <div class="history-item" ${h.sheetUrl?`onclick="window.open('${h.sheetUrl}','_blank')"`:''}>
      <div class="hi-status ${h.status}"></div>
      <div style="font-size:1.4rem">${h.icon}</div>
      <div><div class="hi-name">${h.actor}</div><div class="hi-meta">${h.time}</div></div>
      <div class="hi-rows">${h.rows} rows</div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê API KEY ‚ïê‚ïê‚ïê
function openApiModal() { document.getElementById('modal-api-key').value = STATE.apifyKey; document.getElementById('api-modal').classList.add('show'); }
function closeApiModal() { document.getElementById('api-modal').classList.remove('show'); }
async function saveApiKeyFromModal() {
  const key = document.getElementById('modal-api-key').value.trim();
  if (!key) return;
  STATE.apifyKey = key; localStorage.setItem('apify_key', key);
  document.getElementById('settings-apify-key').value = key;
  updateApiDisplay(); closeApiModal();
  await testApifyKey();
}
function saveApifyKey() {
  const key = document.getElementById('settings-apify-key').value.trim();
  if (!key) return;
  STATE.apifyKey = key; localStorage.setItem('apify_key', key);
  updateApiDisplay(); testApifyKey();
  alert('API key saved!');
}
function updateApiDisplay() {
  const k = STATE.apifyKey;
  document.getElementById('api-key-display').textContent = k ? k.substring(0,16)+'...'+k.slice(-4) : 'Not set ‚Äî click to add';
}
async function testApifyKey() {
  try {
    const r = await fetch(`https://api.apify.com/v2/users/me?token=${STATE.apifyKey}`);
    const d = await r.json();
    if (d.data) {
      const used = d.data.plan?.usedComputeUnits || 0;
      const limit = d.data.plan?.maxComputeUnits || 1000;
      const pct = Math.min(100, Math.round((used/limit)*100));
      document.getElementById('quota-wrap').style.display = 'block';
      document.getElementById('quota-pct').textContent = pct + '%';
      document.getElementById('quota-bar').style.width = pct + '%';
      log(`‚úì Apify key valid ‚Äî Quota used: ${pct}%`, 'l-ok');
    }
  } catch(e) { log('Key check failed: ' + e.message, 'l-warn'); }
}

// ‚ïê‚ïê‚ïê TAB MODAL ‚ïê‚ïê‚ïê
function openTabModal() { document.getElementById('tab-modal').classList.add('show'); }
function closeTabModal() { document.getElementById('tab-modal').classList.remove('show'); }
function confirmNewTab() {
  const name = document.getElementById('new-tab-name').value.trim();
  if (!name) return;
  document.getElementById('custom-tab').value = name;
  closeTabModal();
  document.getElementById('new-tab-name').value = '';
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function log(msg, cls='l-info') {
  const box = document.getElementById('log-box');
  box.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}
function clearLog() { document.getElementById('log-box').innerHTML = ''; }
function setProgress(pct, label) {
  document.getElementById('prog-wrap').style.display = 'block';
  document.getElementById('prog-fill').style.width = pct + '%';
  document.getElementById('prog-label').textContent = label;
  document.getElementById('prog-pct').textContent = pct + '%';
  document.getElementById('run-status').textContent = label;
}
function setRunning(on) {
  const btn = document.getElementById('btn-run');
  btn.disabled = on;
  btn.innerHTML = on ? '<div class="spin"></div><span>Running...</span>' : '<span>‚ñ∂ Start Scraping</span>';
  if (!on) document.getElementById('run-status').textContent = '';
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

renderActors();
</script>
</body>
</html>
